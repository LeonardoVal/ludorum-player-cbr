{"version":3,"sources":["../src/__prologue__.js","../src/CaseBase.js","../src/CBRPlayer.js","../src/dbs/MemoryCaseBase.js","../src/__epilogue__.js","../src/dbs/SQLiteCaseBase.js","../src/utils.js"],"names":["__init__","base","Sermat","ludorum","declare","unimplemented","objects","raise","Randomness","raiseIf","Iterable","iterable","Future","exports","__package__","__name__","__dependencies__","__SERMAT__","include","dbs","utils","CaseBase","constructor","params","this","game","encoding","distance","random","DEFAULT","features1","features2","zip","mapApply","f1","f2","isNaN","Math","abs","sum","addCase","addMatch","match","options","cdb","retainThreshold","run","then","entry","_case","breakStoring","result","history","players","forEach","p","i","length","moves","state","closestDistance","addMatches","matches","matchCount","intervalId","logger","setInterval","info","logTime","sequence","r","clearInterval","populate","n","trainer","RandomPlayer","name","Array","isArray","matchups","tournaments","Measurement","__matches__","toArray","range","ceil","product","Match","cases","nn","k","cb","gameCase","map","features","sorted","c1","c2","slice","closest","Infinity","actionEvaluations","role","roleIndex","indexOf","move","JSON","stringify","toObject","knn","forEachApply","ev","m","actions","count","Object","values","gameEvaluation","static __SERMAT__","identifier","serializer","obj","hasOwnProperty","CBRPlayer","Player","call","caseBase","checkMoves","movesFor","perform","push","decision","choice","action","t","minEval","positiveActions","filter","min","negativeActions","weightedChoice","normalizeWeights","assess","cbrPlayer","evaluation","player","finishedMatchesCount","tuple","matchPlayers","repeat","playerIndex","playerRole","MemoryCaseBase","__cases__","__index__","ply","clone","serialize_CaseBase","SQLiteCaseBase","__setupDatabase__","Database","require","db","__db__","toLowerCase","pragma","__tableName__","tableName","__featureColumns__","_","__actionColumns__","__resultColumns__","rt","__createTable__","register","deterministic","varargs","__distanceFunction__","featureColumns","actionColumns","resultColumns","__runSQL__","colName","join","concat","sql","args","prototype","arguments","stmt","prepare","apply","err","Error","__getSQL__","all","df","middle","__key__","caseKey","chain","changes","pi","sets","__row2case__","row","col","parse","filters","bind","__nn_sql__","v1","v2","encodings","TicTacToe","board","split","chr"],"mappings":";;uGAEA,SAASA,EAASC,EAAMC,EAAQC,GAAW,aAE1C,IAAIC,EAAUH,EAAKG,QAClBC,EAAgBJ,EAAKK,QAAQD,cAC7BE,EAAQN,EAAKM,MAEbC,GADUP,EAAKQ,QACFR,EAAKO,YAClBE,EAAWT,EAAKS,SAChBC,EAAWV,EAAKU,SAChBC,EAASX,EAAKW,OAGXC,GACHC,YAAa,qBACbC,SAAU,qBACVf,SAAUA,EACVgB,kBAAmBf,EAAMC,EAAQC,GACjCc,YAAcC,SAAUjB,EAAME,IAE9BgB,OACAC,UClBEC,EAAWR,EAAQQ,SAAWpB,EAAKG,SACtCkB,YAAa,SAAkBC,GAC9BC,KAAKC,KAAOF,GAAUA,EAAOE,KACzBF,GAAqC,mBAApBA,EAAOG,WAC3BF,KAAKE,SAAWH,EAAOG,UAEpBH,GAAqC,mBAApBA,EAAOI,WAC3BH,KAAKG,SAAWJ,EAAOI,UAExBH,KAAKI,OAASL,GAAUA,EAAOK,QAAUpB,EAAWqB,SAWrDH,SAAUrB,EAAa,WAAa,8BAOpCsB,SAAU,SAAkBG,EAAWC,GACtC,OAAO9B,EAAKS,SAASsB,IAAIF,EAAWC,GAAWE,SAAS,SAAUC,EAAIC,GACrE,OAAW,OAAPD,GAAgBE,MAAMF,IAAc,OAAPC,GAAgBC,MAAMD,GAG/C,EAFAE,KAAKC,IAAIJ,EAAKC,KAIpBI,OAOJC,QAASnC,EAAa,WAAa,kBAKnCoC,SAAU,SAAkBC,EAAOC,GAClC,IAAIC,EAAMpB,KACTqB,GAAmBF,EAAQE,iBAAmB,EAC/C,OAAOH,EAAMI,MAAMC,KAAK,WACvB,IAECC,EAAOC,EAAOC,EAFXC,EAAST,EAAMS,SAClBC,EAAUV,EAAMU,QAEjBR,EAAInB,KAAK4B,QAAQC,QAAQ,SAAUC,GAClCJ,EAAOI,IACNJ,EAAOI,GAAK,EAAI,EAAI,EACN,IAAdJ,EAAOI,GAAW,EAAI,EACtBJ,EAAOI,GAAK,EAAI,EAAI,KAGtB,IAAK,IAAIC,EAAIJ,EAAQK,OAAS,EAAGD,GAAK,MACrCR,EAAQI,EAAQI,IACNE,SACTT,EAAQL,EAAIlB,SAASsB,EAAMW,MAAOX,EAAMU,MAAOF,IACzCL,OAASA,EACfD,EAAmC,IAApBL,GACdA,EAAkBD,EAAIgB,gBAAgBZ,EAAMW,OAC7Cf,EAAIJ,QAAQS,IACRC,IARmCM,KAazC,OAAOd,KAOTmB,WAAY,SAAoBC,EAASnB,GACxC,IAAIC,EAAMpB,KACTuC,EAAa,EACbC,EAAa,EAMd,OALIrB,EAAQsB,SACXD,EAAaE,YAAY,WACxBvB,EAAQsB,OAAOE,KAAI,SAAWJ,EAAW,cACvCpB,EAAQyB,SAAW,MAEhBxD,EAAOyD,SAASP,EAAS,SAAUpB,GAEzC,OADAqB,IACOnB,EAAIH,SAASC,EAAOC,KACzBI,KAAK,SAAUuB,GAKjB,OAJI3B,EAAQsB,QACXtB,EAAQsB,OAAOE,KAAI,SAAWJ,EAAW,aAE1CQ,cAAcP,GACPM,KAkBTE,SAAU,SAAkB7B,GAE3B,IACClB,GAFDkB,EAAUA,OAEMlB,MAAQD,KAAKC,KAC5BgD,EAAIrC,MAAMO,EAAQ8B,GAAK,KAAO9B,EAAQ8B,EACtCC,EAAU/B,EAAQ+B,SAAW,IAAIvE,EAAQkD,QAAQsB,cAAeC,KAAM,iBACtEvB,EAAUV,EAAQU,UAAYqB,GAC1BG,MAAMC,QAAQzB,KAClBA,GAAWA,IAEZ,IACC0B,EADgB,IAAI5E,EAAQ6E,YAAYC,YAAYxD,EAAMiD,EAASrB,EAAS,GACtD6B,cAAcC,UACrC,OAAO3D,KAAKqC,WAAWnD,EAAS0E,MAAM/C,KAAKgD,KAAKZ,EAAIM,EAAStB,SAC3D6B,QAAQP,GACR9C,SAAS,SAAUuB,EAAGd,GACtB,OAAO,IAAIvC,EAAQoF,MAAM9D,EAAMiB,EAAMW,WAClCV,IAQN6C,MAAOnF,EAAa,WAAa,kBAIjCoF,GAAI,SAAYC,EAAGjE,GAClB,IAAIkE,EAAKnE,KACRoE,EAAWpE,KAAKE,SAASD,GAM1B,OALMd,EAASa,KAAKgE,SAASK,IAAI,SAAU5C,GACzC,OAAQA,EAAO0C,EAAGhE,SAASsB,EAAM6C,SAAUF,EAASE,aAClDC,OAAO,SAAUC,EAAIC,GACvB,OAAOD,EAAG,GAAKC,EAAG,KAChBd,UACMe,MAAM,GAAIR,IAMrB9B,gBAAiB,SAAyBnC,GACzC,IAAI0E,EAAU3E,KAAKiE,GAAG,EAAGhE,GACzB,OAA0B,IAAnB0E,EAAQ1C,OAAe2C,EAAAA,EAAWD,EAAQ,GAAG,IAKrDE,kBAAmB,SAA2B5E,EAAM6E,EAAM3D,GACzD,IACC+C,EAAI/C,IAAYA,EAAQ+C,GAAK,GAC7Ba,EAAY9E,EAAK4B,QAAQmD,QAAQF,GACjChC,EAAIrE,EAAKU,SAASc,EAAKiC,QAAQ4C,IAAOT,IAAI,SAAUY,GACnD,OAAQC,KAAKC,UAAUF,IAAQA,EAAM,MACnCG,WACHC,EANQrF,KAMCiE,GAAGC,EAAGjE,GAiBhB,OAhBAd,EAASkG,GAAKC,aAAa,SAAU7D,EAAOtB,GAC3C,IAECoF,EAFGC,EAAI1C,EAAEoC,KAAKC,UAAU1D,EAAMgE,QAAQV,KACtCpD,EAASF,EAAME,OAAOmD,GAEnBU,IAIHD,EAHU9D,EAAMiE,OAAS,GAAKjE,EAAMiE,QAC3B/D,EAAO,GAAKA,EAAO,KACzBA,EAAO,GAAKA,EAAO,KAAOA,EAAO,GAAKA,EAAO,MACxB,GAAK,EAAIxB,IAC7BS,MAAM2E,IACTxG,EAAK,sCAAwCmG,KAAKC,UAAU1D,GAC3D,eAAgBtB,EAAU,MAE5BqF,EAAE,IAAMD,KAGHI,OAAOC,OAAO9C,IAKtB+C,eAAgB,SAAwB5F,EAAM6E,EAAM3D,GACnD,IACC+C,EAAI/C,IAAYA,EAAQ+C,GAAK,GAI7BmB,GAHI5G,EAAKU,SAASc,EAAKiC,QAAQ4C,IAAOT,IAAI,SAAUY,GACnD,OAAQC,KAAKC,UAAUF,IAAQA,EAAM,MACnCG,WAJKpF,KAKCiE,GAAGC,EAAGjE,EAAM6E,IACtB,OAAO3F,EAASkG,GAAKhB,IAAI,SAAU5C,EAAOtB,GACzC,OAAQsB,EAAME,OAAOmD,GAAM,GAAKrD,EAAME,OAAOmD,GAAM,KAAO,EAAI3E,KAC5DY,OAKJ+E,qBACCC,WAAY,WACZC,WAAY,SAA4BC,GACvC,QACChG,KAAMgG,EAAIhG,KACVC,SAAU+F,EAAIC,eAAc,YAAeD,EAAI/F,SAAW,WCrN9Cb,EAAQ8G,UAAY1H,EAAKG,QAAQD,EAAQyH,QAGxDtG,YAAa,SAAmBC,GAC/BpB,EAAQyH,OAAOC,KAAKrG,KAAMD,GAC1BC,KAAKsG,SAAWvG,GAAUA,EAAOuG,SACjCtG,KAAKkE,EAAInE,GAAUA,EAAOmE,GAAK,IAKhCqC,WAAY,SAAoBtG,EAAM6E,GACrC,IAAIhC,UAUJ,OATA9C,KAAKwG,SAASvG,EAAM6E,GAAMhD,QAAQ,SAAUmD,GAC3C,IACCtD,EADW1B,EAAKwG,QAAQxB,EAAMH,GACfnD,SACXA,EAEMA,EAAOmD,GAAQ,GACzBhC,EAAE,GAAG4D,KAAKzB,GAFVnC,EAAE,GAAG4D,KAAKzB,KAKLnC,GASR6D,SAAU,SAAkB1G,EAAM6E,GACjC,IAAIyB,EAAavG,KAAKuG,WAAWtG,EAAM6E,GACvC,GAAIyB,EAAW,GAAGtE,OAAS,EAC1B,OAAOjC,KAAKI,OAAOwG,OAAOL,EAAW,IAC/B,GAAIA,EAAW,GAAGtE,OAAS,EACjC,OAA6B,IAAzBsE,EAAW,GAAGtE,OACVsE,EAAW,GAAG,GAEdvG,KAAKI,OAAOwG,OAAO5G,KAAKwG,SAASvG,EAAM6E,IAGhD,IAAIW,EAAUtG,EAASoH,EAAW,IAAIlC,IAAI,SAAUwC,GAClD,OAAQA,EAAO,IAAMA,EAAQ,MAC3BzB,WACJpF,KAAKsG,SAASzB,kBAAkB5E,EAAM6E,GAAQZ,EAAGlE,KAAKkE,IAAKpC,QAAQ,SAAUgF,GAC5E,IAAItF,EAAQiE,EAAQqB,EAAE,GAAG,IACrBtF,IACHA,EAAM,IAAMsF,EAAE,MAGhB,IAAIC,EAAWnC,EAAAA,EACdoC,EAAkBrB,OAAOC,OAAOH,GAASwB,OAAO,SAAUH,GAEzD,OADAC,EAAUlG,KAAKqG,IAAIH,EAASD,EAAE,IACvBA,EAAE,GAAK,IAEfK,EAAkBxB,OAAOC,OAAOH,GAASwB,OAAO,SAAUH,GACzD,OAAOA,EAAE,IAAM,IACbzC,IAAI,SAAUyC,GAChB,OAAQA,EAAE,GAAIA,EAAE,GAAKC,KAUvB,OAPIC,EAAgB/E,OAAS,EACnBjC,KAAKI,OAAOgH,eAAepH,KAAKI,OAAOiH,iBAAiBL,IAC5B,IAA3BA,EAAgB/E,OACjB+E,EAAgB,GAAG,GAEnBhH,KAAKI,OAAOgH,eAAepH,KAAKI,OAAOiH,iBAAiBF,KAOnEG,OAAQ,SAAgBzF,EAASV,GAC3BkC,MAAMC,QAAQzB,KAClBA,GAAWA,IAEZ,IAAI0F,EAAYvH,KACfC,EAAOD,KAAKsG,SAASrG,KACrBuH,EAAarI,EAAS0C,GAASwC,IAAI,SAAUoD,GAC5C,OAAQA,EAAOrE,KAAMjE,EAASc,EAAK4B,SAASwC,IAAI,SAAUtC,GACxD,OAAQA,GAAI,EAAE,EAAE,MACdqD,cACDA,WACJnC,EAAI9B,IAAYA,EAAQ8B,GAAK,IAC7ByE,EAAuB,EACvBlF,EAAa,EAMd,OALIrB,EAAQsB,SACXD,EAAaE,YAAY,WACxBvB,EAAQsB,OAAOE,KAAI,uBAAyB+E,EAAqB,cAC/DvG,EAAQyB,SAAW,MAEhBnE,EAAKW,OAAOyD,SAASpE,EAAKS,SAAS0E,MAAMX,GAAGa,QAAQjC,GAAU,SAAU8F,GAC9E,IAAIF,EAASE,EAAM,GAClBC,EAAenJ,EAAKS,SAAS2I,OAAOJ,EAAQxH,EAAK4B,QAAQI,QAAQ0B,UACjEmE,EAAcH,EAAM,GAAK1H,EAAK4B,QAAQI,OACtC8F,EAAa9H,EAAK4B,QAAQiG,GAC3BF,EAAaE,GAAeP,EAC5B,IAAIrG,EAAQ,IAAIvC,EAAQoF,MAAM9D,EAAM2H,GACpC,OAAO1G,EAAMI,MAAMC,KAAK,WACvB,IAAIuB,EAAI5B,EAAMS,SAASoG,GACvBP,EAAWC,EAAOrE,MAAM2E,GAAYjF,EAAI,EAAI,EAAIA,EAAI,EAAI,EAAI,KAC5D4E,QAECnG,KAAK,WAKP,OAJAwB,cAAcP,GACVrB,EAAQsB,QACXtB,EAAQsB,OAAOE,KAAI,uBAAyB+E,EAAqB,aAE3DF,OC7GWnI,EAAQM,IAAIqI,eAAiBpJ,EAAQiB,GACzDC,YAAa,SAAwBC,GACpCF,EAASwG,KAAKrG,KAAMD,GACpBC,KAAKiI,aACLjI,KAAKkI,cAGNlE,MAAO,WACN,OAAOvF,EAAKU,SAASa,KAAKiI,YAG3BjH,QAAS,SAAiBS,GAEzB,IAAID,GACHkE,MAAOjE,EAAMiE,OAAS,EACtByC,IAAK1G,EAAM0G,IACX7D,SAAU5F,EAAO0J,MAAM3G,EAAM6C,UAAY,MACzCmB,QAAS/G,EAAO0J,MAAM3G,EAAMgE,SAAW,MACvC9D,OAAQjD,EAAO0J,MAAM3G,EAAME,QAAU,OAEtC,OAAO3B,KAAKiI,UAAUvB,KAAKlF,IAK5BsE,qBACCC,WAAY,iBACZC,WAAY,SAAkCC,GAC7C,OAAOpG,EAASJ,WAAW4I,mBAAmBpC,OC/BhD,OCGD5G,EAAQM,IAAI2I,eAAiB7J,EAAKG,QAAQiB,GAGzCC,YAAa,SAAwBC,GACpCF,EAASwG,KAAKrG,KAAMD,GACpBC,KAAKuI,kBAAkBxI,IAOxBwI,kBAAmB,SAA2BxI,GAC7C,IAAIE,EAAOD,KAAKC,KACfuI,EAAWxI,KAAKwI,UAAYC,QAAO,kBAChC1I,EAAO2I,cAAcF,EACxBxI,KAAK2I,OAAS5I,EAAO2I,IAErB1I,KAAK2I,OAAS,IAAIH,EAA8B,iBAAdzI,EAAO2I,GAAkB3I,EAAO2I,GACjE,KAAMzI,EAAKmD,KAAKwF,cAAc,eAC/B5I,KAAK2I,OAAOE,OAAM,sBAClB7I,KAAK2I,OAAOE,OAAM,wBAClB7I,KAAK2I,OAAOE,OAAM,uBAGnB7I,KAAK8I,cAAgB/I,EAAOgJ,WAAa,MAAO9I,EAAKmD,KACrD,IAAIlD,EAAWF,KAAKE,SAASD,EAAMA,EAAKiC,SACxClC,KAAKgJ,mBAAqB9I,EAASoE,SAASD,IAAI,SAAU4E,EAAGjH,GAC5D,MAAO,IAAKA,IAEbhC,KAAKkJ,kBAAoBjJ,EAAK4B,QAAQwC,IAAI,SAAU4E,EAAGjH,GACtD,MAAO,IAAKA,IAEbhC,KAAKmJ,kBAAoB1K,EAAKS,SAAS0E,MAAM3D,EAAK4B,QAAQI,QACxD6B,SAAO,MAAS,OAAQ,SACxBrD,SAAS,SAAUsB,EAAGqH,GACtB,OAAOA,EAAKrH,IACV4B,UACJ3D,KAAKqJ,kBACLrJ,KAAK2I,OAAOW,UAAWlG,KAAM,WAAYmG,eAAe,EAAMC,SAAS,GACtExJ,KAAKyJ,qBAAqBzJ,KAAKG,YAGjCkJ,gBAAiB,SAAyBN,EAAWW,EAAgBC,EAAeC,GAMnF,OALAb,EAAYA,GAAa/I,KAAK8I,cAC9BY,EAAiBA,GAAkB1J,KAAKgJ,mBACxCW,EAAgBA,GAAiB3J,KAAKkJ,kBACtCU,EAAgBA,GAAiB5J,KAAKmJ,kBAE/BnJ,KAAK6J,WAAU,8BAAgCd,EACrD,mDACAY,EAActF,IAAI,SAAUyF,GAC3B,OAAOA,EAAQ,UACbC,KAAI,MAAO,KACdH,EAAcI,OAAON,GAAgBrF,IAAI,SAAUyF,GAClD,OAAOA,EAAQ,aACbC,KAAI,MACR,MAGDF,WAAY,SAAoBI,GAC/B,IAAIC,EAAO7G,MAAM8G,UAAUzF,MAAM2B,KAAK+D,UAAW,GACjD,IACC,IAAIC,EAAOrK,KAAK2I,OAAO2B,QAAQL,GAC/B,OAAOI,EAAK/I,IAAIiJ,MAAMF,EAAMH,GAC3B,MAAOM,GACR,MAAM,IAAIC,MAAK,oBAAsBR,EAAI,KAAO/E,KAAKC,UAAU+E,GAAM,OAIvEQ,WAAY,SAAoBT,GAC/B,IAAIC,EAAO7G,MAAM8G,UAAUzF,MAAM2B,KAAK+D,UAAW,GACjD,IACC,IAAIC,EAAOrK,KAAK2I,OAAO2B,QAAQL,GAC/B,OAAOI,EAAKM,IAAIJ,MAAMF,EAAMH,GAC3B,MAAOM,GACR,MAAM,IAAIC,MAAK,mBAAqBR,EAAI,KAAO/E,KAAKC,UAAU+E,GAAM,OAQtET,qBAAsB,SAA8BmB,GACnDA,EAAKA,GAAM5K,KAAKG,SAChB,IAAIG,KACHC,KACD,OAAO,WAEN,IADA,IAAIsK,EAAUT,UAAUnI,OAAS,EAAI,EAC5BD,EAAI,EAAGA,EAAI6I,EAAQ7I,IAC3B1B,EAAUoG,KAAK0D,UAAUpI,IACzBzB,EAAUmG,KAAK0D,UAAUS,EAAS7I,IAEnC,OAAO4I,EAAGtK,EAAWC,KASvBuK,QAAS,SAAiBrJ,GACzB,IAAI6C,EAAW7C,EAAM6C,SACpBmB,EAAUhE,EAAMgE,SAAWzF,KAAKC,KAAK4B,QAAQwC,IAAI,WAChD,OAAO,OAET,OAAOC,EAASyF,KAAI,KAAM,IAAMtE,EAAQsE,KAAI,MAG7C/I,QAAS,SAAiBS,GACzB,IAAII,EAAU7B,KAAKC,KAAK4B,QACvBkJ,EAAU/K,KAAK8K,QAAQrJ,GACvBwI,EAAM,yBAA0BjK,KAAK8I,cAAc,YAClD5J,EAAS2I,OAAM,IAAM,EAAI7H,KAAKkJ,kBAAkBjH,OAC/CjC,KAAKmJ,kBAAkBlH,OAASjC,KAAKgJ,mBAAmB/G,QAAQ8H,KAAI,KAAM,IACpE/J,KAAK6J,WAAWI,GAAMc,EAAS,EAAGtJ,EAAM0G,KAC9C6B,OAAOvI,EAAMgE,QAAQpB,IAAI,SAAUwC,GACnC,OAAkB,OAAXA,EAAkB,KAAO3B,KAAKC,UAAU0B,MAE/CmD,OAAO9K,EAAS8L,MAAMT,MAAMrL,EAAU2C,EAAQwC,IAAI,SAAUtC,GAC5D,OAAON,EAAME,OAAOI,MACjB4B,WACHqG,OAAOvI,EAAM6C,WACb2G,QAAU,GAEZjL,KAAK6J,WAAU,UAAY7J,KAAK8I,cAAc,iDACIrH,EAAM0G,KAAO,GAAG,oBACjEtG,EAAQwC,IAAI,SAAUtC,GACrB,IAAIe,EAAIrB,EAAME,OAAOI,GACpBmJ,EAAKrJ,EAAQmD,QAAQjD,GACrBoJ,KAUD,OATIrI,EAAE,IACLqI,EAAKzE,KAAI,MAAQwE,EAAG,SAAWA,EAAG,MAAQpI,EAAE,IAEzCA,EAAE,IACLqI,EAAKzE,KAAI,OAASwE,EAAG,UAAYA,EAAG,MAAQpI,EAAE,IAE3CA,EAAE,IACLqI,EAAKzE,KAAI,OAASwE,EAAG,UAAYA,EAAG,MAAQpI,EAAE,IAExCqI,EAAKpB,KAAI,QACdA,KAAI,MAAO,iBAAoBgB,EAAQ,MAK7CK,aAAc,SAAsBC,GACnC,OACC3F,MAAO2F,EAAI3F,MACXyC,IAAKkD,EAAIlD,IACT7D,SAAUtE,KAAKgJ,mBAAmB3E,IAAI,SAAUiH,GAC/C,OAAOD,EAAIC,KAEZ7F,QAASzF,KAAKkJ,kBAAkB7E,IAAI,SAAUiH,GAC7C,OAAOpG,KAAKqG,MAAMF,EAAIC,MAEvB3J,OAAQxC,EAASa,KAAKC,KAAK4B,SAASwC,IAAI,SAAUoD,EAAQzF,GACzD,OAAQyF,GAAS4D,EAAG,MAAQrJ,GAAIqJ,EAAG,OAASrJ,GAAIqJ,EAAG,OAASrJ,OAC1DoD,aAILpB,MAAO,SAAewH,GACrB,OAAOxL,KAAK0K,WAAU,iBAAmB1K,KAAK8I,eAC5CzE,IAAIrE,KAAKoL,aAAaK,KAAKzL,QAG9B0L,WAAY,SAAoBxH,EAAGjE,GAClC,IAAImE,EAAWpE,KAAKE,SAASD,GAC7B,MAAO,cACNf,EAASsB,IAAIR,KAAKgJ,mBAAoB5E,EAASE,UAAU7D,SAAS,SAAUkL,EAAIC,GAC/E,OAAc,OAAPA,GAAgBhL,MAAMgL,GAA6C,IAAvC,cAAeD,EAAG,KAAOC,EAAG,UAC7D7B,KAAI,KAAM,sBACJ/J,KAAK8I,cAAc,gCACI5E,GAGlCD,GAAI,SAAYC,EAAGjE,GAClB,IAAIkE,EAAKnE,KACRiK,EAAMjK,KAAK0L,WAAWxH,EAAGjE,GAC1B,OAAOD,KAAK2I,OAAO2B,QAAQL,GAAKU,MAAMtG,IAAI,SAAUgH,GACnD,OAAQlH,EAAGiH,aAAaC,GAAMA,EAAIlL,aAMpC2F,qBACCC,WAAY,iBACZC,WAAY,SAAkCC,GAC7C,OAAOpG,EAASJ,WAAW4I,mBAAmBpC,OC9LjD5G,EAAQO,MAAMiM,WAMbC,UAAW,SAA2B7L,EAAMiC,EAAOiG,GAClD,OACCA,IAAKA,EACL7D,SAAUrE,EAAK8L,MAAMC,MAAK,IAAK3H,IAAI,SAAU4H,GAC5C,MAAe,MAARA,EAAc,EAAe,MAARA,GAAgB,EAAK,IAElDxG,QAAUvD,EAAejC,EAAK4B,QAAQwC,IAAI,SAAUtC,GACnD,OAAOG,EAAMgE,eAAenE,GAAKG,EAAMH,GAAK,OAD3B,QFjBb1C","file":"ludorum-player-cbr-tag.min.js","sourcesContent":["/** Package wrapper and layout.\n*/\nfunction __init__(base, Sermat, ludorum) { \"use strict\";\n// Import synonyms. ////////////////////////////////////////////////////////////////////////////////\n\tvar declare = base.declare,\n\t\tunimplemented = base.objects.unimplemented,\n\t\traise = base.raise,\n\t\traiseIf = base.raiseIf,\n\t\tRandomness = base.Randomness,\n\t\tIterable = base.Iterable,\n\t\titerable = base.iterable,\n\t\tFuture = base.Future;\n\n// Library layout. /////////////////////////////////////////////////////////////////////////////////\n\tvar exports = {\n\t\t__package__: 'ludorum-player-cbr',\n\t\t__name__: 'ludorum_player_cbr',\n\t\t__init__: __init__,\n\t\t__dependencies__: [base, Sermat, ludorum],\n\t\t__SERMAT__: { include: [base, ludorum] },\n\n\t\tdbs: { /* Namespace for different types of case bases. */ },\n\t\tutils: { /* Namespace for different utility functions and definitions. */ }\n\t};\n","/** # CaseBase \n\nA `CaseBase` holds all cases for a game.\n*/\nvar CaseBase = exports.CaseBase = base.declare({\n\tconstructor: function CaseBase(params) {\n\t\tthis.game = params && params.game;\n\t\tif (params && typeof params.encoding === 'function') {\n\t\t\tthis.encoding = params.encoding;\n\t\t}\n\t\tif (params && typeof params.distance === 'function') {\n\t\t\tthis.distance = params.distance;\n\t\t}\n\t\tthis.random = params && params.random || Randomness.DEFAULT;\n\t},\n\n\t/** The `encoding` of a case takes a `game` state and the `moves` performed and returns an \n\tobjects with the following data:\n\t\n\t+ `features`: An array of integer values that identify with the game state,\n\n\t+ `actions`: An array with one value per player, an integer identifying an action if the player\n\tis active, or `null` if the player has not moved.\n\t*/\n\tencoding: unimplemented('CaseBase', 'encoding(game, moves, ply)'),\n\n\t/** ## Distances ########################################################################### */\n\n\t/** The default `distance` is a form of Manhattan distance, which does not count `null` or \n\t`NaN` features.\n\t*/\n\tdistance: function distance(features1, features2) {\n\t\treturn base.Iterable.zip(features1, features2).mapApply(function (f1, f2) {\n\t\t\tif (f1 !== null && !isNaN(f1) && f2 !== null && !isNaN(f2)) {\n\t\t\t\treturn Math.abs(f1 - f2);\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t}).sum();\n\t},\n\n\t/** ## Case acquisition #################################################################### */\n\n\t/** Adding a case to the database is not implemented by default.\n\t*/\n\taddCase: unimplemented('CaseBase', 'addCase(_case)'),\n\n\t/** The `addMatch` method runs the given `match` and adds all its game states as cases in the\n\tdatabase. It returns a promise.\n\t*/\n\taddMatch: function addMatch(match, options) {\n\t\tvar cdb = this,\n\t\t\tretainThreshold = +options.retainThreshold || 0;\n\t\treturn match.run().then(function () {\n\t\t\tvar result = match.result(),\n\t\t\t\thistory = match.history,\n\t\t\t\tentry, _case, breakStoring;\n\t\t\tcdb.game.players.forEach(function (p) {\n\t\t\t\tresult[p] = [\n\t\t\t\t\tresult[p] > 0 ? 1 : 0,\n\t\t\t\t\tresult[p] === 0 ? 1 : 0,\n\t\t\t\t\tresult[p] < 0 ? 1 : 0,\n\t\t\t\t];\n\t\t\t});\n\t\t\tfor (var i = history.length - 1; i >= 0; i--) {\n\t\t\t\tentry = history[i];\n\t\t\t\tif (entry.moves) {\n\t\t\t\t\t_case = cdb.encoding(entry.state, entry.moves, i);\n\t\t\t\t\t_case.result = result;\n\t\t\t\t\tbreakStoring = retainThreshold !== 0 &&\n\t\t\t\t\t\tretainThreshold > cdb.closestDistance(entry.state);\n\t\t\t\t\tcdb.addCase(_case);\n\t\t\t\t\tif (breakStoring) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn match;\n\t\t});\n\t},\n\n\t/** The `addMatches` method takes a sequence of `matches`, runs each in order and adds all \n\tresulting game states to the database. It returns a promise.\n\t*/\n\taddMatches: function addMatches(matches, options) {\n\t\tvar cdb = this,\n\t\t\tmatchCount = 0,\n\t\t\tintervalId = 0;\n\t\tif (options.logger) {\n\t\t\tintervalId = setInterval(function () {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}, options.logTime || 30000);\n\t\t}\n\t\treturn Future.sequence(matches, function (match) {\n\t\t\tmatchCount++;\n\t\t\treturn cdb.addMatch(match, options);\n\t\t}).then(function (r) {\n\t\t\tif (options.logger) {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}\n\t\t\tclearInterval(intervalId);\n\t\t\treturn r;\n\t\t});\n\t},\n\n\t/** The `populate` method adds cases to the database by running several matches and adding the\n\tresulting game states. The `options` argument may include the following:\n\n\t+ `game`: The game state from which to start the matches. The database's `game` is used by \n\tdefault.\n\n\t+ `n`: The number of matches to run; 100 by default.\n\n\t+ `trainer`: The player to use agains the opponents. A random player is used by default.\n\n\t+ `players`: The trainer's opponents to use to play the matches. The trainer is used by default.\n\n\tOther options are passed to the `addMatches` method. The result is a promise.\n\t*/\n\tpopulate: function populate(options) {\n\t\toptions = options || {};\n\t\tvar cdb = this,\n\t\t\tgame = options.game || this.game,\n\t\t\tn = isNaN(options.n) ? 100 : +options.n,\n\t\t\ttrainer = options.trainer || new ludorum.players.RandomPlayer({ name: 'RandomPlayer' }),\n\t\t\tplayers = options.players || [trainer];\n\t\tif (!Array.isArray(players)) {\n\t\t\tplayers = [players];\n\t\t}\n\t\tvar tournament = new ludorum.tournaments.Measurement(game, trainer, players, 1),\n\t\t\tmatchups = tournament.__matches__().toArray();\n\t\treturn this.addMatches(Iterable.range(Math.ceil(n / matchups.length))\n\t\t\t.product(matchups)\n\t\t\t.mapApply(function (i, match) {\n\t\t\t\treturn new ludorum.Match(game, match.players);\n\t\t\t}), options);\n\t},\n\n\t/** ## Database use ######################################################################## */\n\n\t/** The `cases` method returns the sequence of all cases in the database. Case order is not\n\tdefined.\n\t*/\n\tcases: unimplemented('CaseBase', 'cases(filters)'),\n\n\t/** The `nn` method returns the `k` neareast neighbours of the given game state. \n\t*/\n\tnn: function nn(k, game) {\n\t\tvar cb = this,\n\t\t\tgameCase = this.encoding(game),\n\t\t\tcs = iterable(this.cases()).map(function (_case) {\n\t\t\t\treturn [_case, cb.distance(_case.features, gameCase.features)];\n\t\t\t}).sorted(function (c1, c2) {\n\t\t\t\treturn c1[1] - c2[1];\n\t\t\t}).toArray();\n\t\treturn cs.slice(0, +k);\n\t},\n\n\t/** The `closestDistance` method returns the distance to the closest case in the case base from\n\tthe given game state.\n\t*/\n\tclosestDistance: function closestDistance(game) {\n\t\tvar closest = this.nn(1, game);\n\t\treturn closest.length === 0 ? Infinity : closest[0][1];\n\t},\n\n\t/**TODO\n\t*/\n\tactionEvaluations: function actionEvaluations(game, role, options) {\n\t\tvar cb = this,\n\t\t\tk = options && +options.k || 10,\n\t\t\troleIndex = game.players.indexOf(role),\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = cb.nn(k, game);\n\t\titerable(knn).forEachApply(function (_case, distance) {\n\t\t\tvar m = r[JSON.stringify(_case.actions[roleIndex])],\n\t\t\t\tresult = _case.result[role],\n\t\t\t\tev, support, ratio;\n\t\t\tif (m) {\n\t\t\t\tsupport = _case.count / (10 + _case.count);\n\t\t\t\tratio = (result[0] + result[2] && \n\t\t\t\t\t((result[0] - result[2]) / (result[0] + result[2])));\n\t\t\t\tev = support * ratio * (1 / (1 + distance));\n\t\t\t\tif (isNaN(ev)) {\n\t\t\t\t\traise(\"Action evaluation is NaN for case: \", JSON.stringify(_case),\n\t\t\t\t\t\t\" (distance= \", distance, \")!\");\n\t\t\t\t}\n\t\t\t\tm[1] += ev;\n\t\t\t}\n\t\t});\n\t\treturn Object.values(r);\n\t},\n\n\t/**TODO\n\t*/\n\tgameEvaluation: function gameEvaluation(game, role, options) { //FIXME\n\t\tvar cb = this,\n\t\t\tk = options && +options.k || 10,\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = cb.nn(k, game, role);\n\t\treturn iterable(knn).map(function (_case, distance) {\n\t\t\treturn (_case.result[role][0] - _case.result[role][2]) / (1 + distance);\n\t\t}).sum();\n\t},\n\n\t/** ## Utilities ########################################################################### */\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'CaseBase',\n\t\tserializer: function serialize_CaseBase(obj) { //FIXME\n\t\t\treturn [{\n\t\t\t\tgame: obj.game,\n\t\t\t\tencoding: obj.hasOwnProperty('encoding') ? obj.encoding : null\n\t\t\t}];\n\t\t}\n\t},\n}); // declare CaseBase","/** # CBR Player \n\n*/\nvar CBRPlayer = exports.CBRPlayer = base.declare(ludorum.Player, {\n\t/** \n\t*/\n\tconstructor: function CBRPlayer(params) {\n\t\tludorum.Player.call(this, params);\n\t\tthis.caseBase = params && params.caseBase;\n\t\tthis.k = params && params.k || 20;\n\t},\n\n\t/** \n\t*/\n\tcheckMoves: function checkMoves(game, role) {\n\t\tvar r = [[], []];\n\t\tthis.movesFor(game, role).forEach(function (move) {\n\t\t\tvar game2 = game.perform(move, role),\n\t\t\t\tresult = game2.result();\n\t\t\tif (!result) {\n\t\t\t\tr[1].push(move); // Not a losing move.\n\t\t\t} else if (result[role] > 0) {\n\t\t\t\tr[0].push(move); // Winning move.\n\t\t\t}\n\t\t});\n\t\treturn r;\n\t},\n\n\t/** A `CBRPlayer` takes the action evaluations from the case base, and splits them into actions\n\twith possitive evaluations and the ones with evaluations less than or equal to zero. If there\n\tare possitively evaluated actions, one of these is chosen randomly with a probability \n\tproportional to the evaluation. If all actions have non possitive evaluations, one of these is\n\tchosen with a probability inversely proportional to the evaluation.   \n\t*/\n\tdecision: function decision(game, role) {\n\t\tvar checkMoves = this.checkMoves(game, role);\n\t\tif (checkMoves[0].length > 0) {\n\t\t\treturn this.random.choice(checkMoves[0]);\n\t\t} else if (checkMoves[1].length < 2) {\n\t\t\tif (checkMoves[1].length === 1) {\n\t\t\t\treturn checkMoves[1][0];\n\t\t\t} else { // if (checkMoves[1].length < 1)\n\t\t\t\treturn this.random.choice(this.movesFor(game, role));\n\t\t\t}\n\t\t}\n\t\tvar actions = iterable(checkMoves[1]).map(function (action) {\n\t\t\t\treturn [action +'', [action, 0]];\n\t\t\t}).toObject();\n\t\tthis.caseBase.actionEvaluations(game, role, { k: this.k }).forEach(function (t) {\n\t\t\tvar entry = actions[t[0] +''];\n\t\t\tif (entry) {\n\t\t\t\tentry[1] += t[1];\n\t\t\t}\n\t\t});\n\t\tvar minEval = +Infinity,\n\t\t\tpositiveActions = Object.values(actions).filter(function (t) {\n\t\t\t\tminEval = Math.min(minEval, t[1]);\n\t\t\t\treturn t[1] > 0;\n\t\t\t}),\n\t\t\tnegativeActions = Object.values(actions).filter(function (t) {\n\t\t\t\treturn t[1] <= 0;\n\t\t\t}).map(function (t) {\n\t\t\t\treturn [t[0], t[1] - minEval];\n\t\t\t}),\n\t\t\tresult;\n\t\tif (positiveActions.length > 1) {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(positiveActions));\n\t\t} else if (positiveActions.length === 1) {\n\t\t\tresult = positiveActions[0][0];\n\t\t} else {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(negativeActions));\n\t\t}\n\t\treturn result;\n\t},\n\n\t// Utilities. /////////////////////////////////////////////////////////////////////////////////\n\n\tassess: function assess(players, options) {\n\t\tif (!Array.isArray(players)) {\n\t\t\tplayers = [players];\n\t\t}\n\t\tvar cbrPlayer = this,\n\t\t\tgame = this.caseBase.game,\n\t\t\tevaluation = iterable(players).map(function (player) {\n\t\t\t\treturn [player.name, iterable(game.players).map(function (p) {\n\t\t\t\t\t\treturn [p, [0,0,0]];\n\t\t\t\t\t}).toObject()];\n\t\t\t\t}).toObject(),\n\t\t\tn = options && +options.n || 300,\n\t\t\tfinishedMatchesCount = 0,\n\t\t\tintervalId = 0;\n\t\tif (options.logger) {\n\t\t\tintervalId = setInterval(function () {\n\t\t\t\toptions.logger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t\t}, options.logTime || 30000);\n\t\t}\n\t\treturn base.Future.sequence(base.Iterable.range(n).product(players), function (tuple) {\n\t\t\tvar player = tuple[1],\n\t\t\t\tmatchPlayers = base.Iterable.repeat(player, game.players.length).toArray(),\n\t\t\t\tplayerIndex = tuple[0] % game.players.length,\n\t\t\t\tplayerRole = game.players[playerIndex];\n\t\t\tmatchPlayers[playerIndex] = cbrPlayer;\n\t\t\tvar match = new ludorum.Match(game, matchPlayers);\n\t\t\treturn match.run().then(function () {\n\t\t\t\tvar r = match.result()[playerRole];\n\t\t\t\tevaluation[player.name][playerRole][r > 0 ? 0 : r < 0 ? 2 : 1]++;\n\t\t\t\tfinishedMatchesCount++;\n\t\t\t});\n\t\t}).then(function () {\n\t\t\tclearInterval(intervalId);\n\t\t\tif (options.logger) {\n\t\t\t\toptions.logger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t\t}\n\t\t\treturn evaluation;\n\t\t});\n\t}\n}); // declare CBRPlayer","/** # MemoryCaseBase\n\nA memory implementation of a `CaseBase`.\n*/\nvar MemoryCaseBase = exports.dbs.MemoryCaseBase = declare(CaseBase, {\n\tconstructor: function MemoryCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__cases__ = [];\n\t\tthis.__index__ = {};\n\t},\n\n\tcases: function cases() {\n\t\treturn base.iterable(this.__cases__);\n\t},\n\t\n\taddCase: function addCase(_case) {\n\t\t//TODO Check `_case` properties.\n\t\tvar entry = {\n\t\t\tcount: _case.count || 0,\n\t\t\tply: _case.ply,\n\t\t\tfeatures: Sermat.clone(_case.features || null),\n\t\t\tactions: Sermat.clone(_case.actions || null),\n\t\t\tresult: Sermat.clone(_case.result || null)\n\t\t};\n\t\treturn this.__cases__.push(entry);\n\t},\n\n\t/** ## Utilities ########################################################################### */\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'MemoryCaseBase',\n\t\tserializer: function serialize_MemoryCaseBase(obj) {\n\t\t\treturn CaseBase.__SERMAT__.serialize_CaseBase(obj);\n\t\t}\n\t},\n}); // declare MemoryCaseBase","// See __prologue__.js\n\treturn exports;\n}\n","/** # SQLiteCaseBase\n\nAn implementation of a `CaseBase` using SQLite3 through `better-sqlite3`.\n*/\nexports.dbs.SQLiteCaseBase = base.declare(CaseBase, {\n\t/** \n\t*/\n\tconstructor: function SQLiteCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__setupDatabase__(params);\n\t},\n\n\t/** ## Database setup and management ####################################################### */\n\n\t/**\n\t*/\n\t__setupDatabase__: function __setupDatabase__(params) {\n\t\tvar game = this.game,\n\t\t\tDatabase = this.Database || require('better-sqlite3');\n\t\tif (params.db instanceof Database) {\n\t\t\tthis.__db__ = params.db;\n\t\t} else {\n\t\t\tthis.__db__ = new Database(typeof params.db === 'string' ? params.db : \n\t\t\t\t'./'+ game.name.toLowerCase() +'-cbr.sqlite');\n\t\t\tthis.__db__.pragma('journal_mode = OFF'); // Disable transactions.\n\t\t\tthis.__db__.pragma('cache_size = -128000'); // Increase default cache size.\n\t\t\tthis.__db__.pragma('encoding = \"UTF-8\"'); // Increase default cache size.\n\t\t}\n\t\t\n\t\tthis.__tableName__ = params.tableName || 'CB_'+ game.name;\n\t\tvar encoding = this.encoding(game, game.moves());\n\t\tthis.__featureColumns__ = encoding.features.map(function (_, i) {\n\t\t\treturn 'f'+ i;\n\t\t});\n\t\tthis.__actionColumns__ = game.players.map(function (_, i) {\n\t\t\treturn 'a'+ i;\n\t\t});\n\t\tthis.__resultColumns__ = base.Iterable.range(game.players.length)\n\t\t\t.product(['won', 'tied', 'lost'])\n\t\t\t.mapApply(function (p, rt) { // result columns\n\t\t\t\treturn rt + p;\n\t\t\t}).toArray();\n\t\tthis.__createTable__();\n\t\tthis.__db__.register({ name: 'distance', deterministic: true, varargs: true },\n\t\t\tthis.__distanceFunction__(this.distance));\n\t},\n\n\t__createTable__: function __createTable__(tableName, featureColumns, actionColumns, resultColumns) {\n\t\ttableName = tableName || this.__tableName__;\n\t\tfeatureColumns = featureColumns || this.__featureColumns__;\n\t\tactionColumns = actionColumns || this.__actionColumns__;\n\t\tresultColumns = resultColumns || this.__resultColumns__;\n\n\t\treturn this.__runSQL__('CREATE TABLE IF NOT EXISTS '+ tableName +\n\t\t\t'(key TEXT PRIMARY KEY, count INTEGER, ply REAL, '+\n\t\t\tactionColumns.map(function (colName) {\n\t\t\t\treturn colName +' TEXT';\n\t\t\t}).join(', ') +', '+\n\t\t\tresultColumns.concat(featureColumns).map(function (colName) {\n\t\t\t\treturn colName +' INTEGER';\n\t\t\t}).join(', ') +\n\t\t')');\n\t},\n\n\t__runSQL__: function __runSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.run.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error executing `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t__getSQL__: function __getSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.all.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error querying `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t/** The distance function of the case base is used in many SQL statements sent to the database.\n\tSince SQLite functions cannot handle arrays, a variadic form that takes both feature arrays in\n\ta chain is built.\n\t*/\n\t__distanceFunction__: function __distanceFunction__(df) {\n\t\tdf = df || this.distance;\n\t\tvar features1 = [], \n\t\t\tfeatures2 = [];\n\t\treturn function () {\n\t\t\tvar middle = (arguments.length / 2) |0;\n\t\t\tfor (var i = 0; i < middle; i++) {\n\t\t\t\tfeatures1.push(arguments[i]);\n\t\t\t\tfeatures2.push(arguments[middle + i]);\n\t\t\t}\n\t\t\treturn df(features1, features2);\n\t\t};\n\t}, \n\n\t/** ## Cases ############################################################################### */\n\n\t/** The cases table's primary key is a string that identifies the case. By default, the \n\tconcatenation of feature values and actions values is used.\n\t*/\n\t__key__: function __key__(_case) {\n\t\tvar features = _case.features,\n\t\t\tactions = _case.actions || this.game.players.map(function () {\n\t\t\t\treturn null;\n\t\t\t});\n\t\treturn features.join(',') +':'+ actions.join(',');\n\t},\n\n\taddCase: function addCase(_case) {\n\t\tvar players = this.game.players,\n\t\t\tcaseKey = this.__key__(_case),\n\t\t\tsql = 'INSERT OR IGNORE INTO '+ this.__tableName__ +' VALUES ('+ \n\t\t\t\tIterable.repeat('?', 3 + this.__actionColumns__.length + \n\t\t\t\t\tthis.__resultColumns__.length + this.__featureColumns__.length).join(',') +')',\n\t\t\tisNew = this.__runSQL__(sql, [caseKey, 1, _case.ply]\n\t\t\t\t.concat(_case.actions.map(function (action) {\n\t\t\t\t\treturn action === null ? null : JSON.stringify(action);\n\t\t\t\t}))\n\t\t\t\t.concat(Iterable.chain.apply(Iterable, players.map(function (p) {\n\t\t\t\t\treturn _case.result[p];\n\t\t\t\t})).toArray())\n\t\t\t\t.concat(_case.features)\n\t\t\t).changes > 0;\n\t\tif (!isNew) { // Insert was ignored because the case is already stored.\n\t\t\tthis.__runSQL__('UPDATE '+ this.__tableName__ +' '+\n\t\t\t\t'SET count = count + 1, ply = (ply * count + '+ (_case.ply || 0) +') / (count + 1), '+\n\t\t\t\tplayers.map(function (p) {\n\t\t\t\t\tvar r = _case.result[p],\n\t\t\t\t\t\tpi = players.indexOf(p),\n\t\t\t\t\t\tsets = [];\n\t\t\t\t\tif (r[0]) {\n\t\t\t\t\t\tsets.push('won'+ pi +' = won'+ pi +' + '+ r[0]);\n\t\t\t\t\t}\n\t\t\t\t\tif (r[1]) {\n\t\t\t\t\t\tsets.push('tied'+ pi +' = tied'+ pi +' + '+ r[1]);\n\t\t\t\t\t}\n\t\t\t\t\tif (r[2]) {\n\t\t\t\t\t\tsets.push('lost'+ pi +' = lost'+ pi +' + '+ r[2]);\n\t\t\t\t\t}\n\t\t\t\t\treturn sets.join(', ');\n\t\t\t\t}).join(', ') +' WHERE key = \\''+ caseKey +'\\''\n\t\t\t);\n\t\t}\n\t},\n\n\t__row2case__: function __row2case__(row) {\n\t\treturn {\n\t\t\tcount: row.count,\n\t\t\tply: row.ply,\n\t\t\tfeatures: this.__featureColumns__.map(function (col) {\n\t\t\t\treturn row[col];\n\t\t\t}),\n\t\t\tactions: this.__actionColumns__.map(function (col) {\n\t\t\t\treturn JSON.parse(row[col]);\n\t\t\t}),\n\t\t\tresult: iterable(this.game.players).map(function (player, i) {\n\t\t\t\treturn [player, [row['won'+ i], row['tied'+ i], row['lost'+ i]]];\n\t\t\t}).toObject()\n\t\t};\n\t},\n\n\tcases: function cases(filters) {\n\t\treturn this.__getSQL__('SELECT * FROM '+ this.__tableName__) //TODO Filters\n\t\t\t.map(this.__row2case__.bind(this));\n\t},\n\n\t__nn_sql__: function __nn_sql__(k, game) {\n\t\tvar gameCase = this.encoding(game);\n\t\treturn 'SELECT *, ('+ \n\t\t\tIterable.zip(this.__featureColumns__, gameCase.features).mapApply(function (v1, v2) {\n\t\t\t\treturn v2 !== null && !isNaN(v2) ? 'abs(ifnull('+ v1 +'-('+ v2 +'),0))' : '0';\n\t\t\t}).join('+') +') AS distance '+\n\t\t\t'FROM '+ this.__tableName__ +' '+\n\t\t\t'ORDER BY distance ASC LIMIT '+ k;\n\t},\n\n\tnn: function nn(k, game) {\n\t\tvar cb = this,\n\t\t\tsql = this.__nn_sql__(k, game);\n\t\treturn this.__db__.prepare(sql).all().map(function (row) {\n\t\t\treturn [cb.__row2case__(row), row.distance];\n\t\t});\n\t},\n\n\t// Utilities //////////////////////////////////////////////////////////////////////////////////\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'SQLiteCaseBase',\n\t\tserializer: function serialize_SQLiteCaseBase(obj) {\n\t\t\treturn CaseBase.__SERMAT__.serialize_CaseBase(obj);\n\t\t}\n\t},\n}); // declare SQLiteCaseBase\n\n","/** # Utilities\r\n\r\n*/\r\n\r\n/** This library provides some `encodings` for simple games in Ludorum for testing purposes.\r\n*/\r\nexports.utils.encodings = {\r\n\t/** The `TicTacToe` encoding has 9 features, one per square in the board. Each feature has the\r\n\tvalue of 0 if it is marked with an X, 1 if it is marked with an O, or 0.5 otherwise.\r\n\r\n\tTicTacToe's actions are numbers, hence no transformation or encoding is required.\r\n\t*/\r\n\tTicTacToe: function encodingTicTacToe(game, moves, ply) {\r\n\t\treturn {\r\n\t\t\tply: ply,\r\n\t\t\tfeatures: game.board.split('').map(function (chr) {\r\n\t\t\t\treturn chr === 'X' ? (+1) : chr === 'O' ? (-1) : 0; \r\n\t\t\t}),\r\n\t\t\tactions: !moves ? null : game.players.map(function (p) {\r\n\t\t\t\treturn moves.hasOwnProperty(p) ? moves[p] : null;\r\n\t\t\t})\r\n\t\t};\r\n\t}\r\n};"]}