{"version":3,"sources":["../src/__prologue__.js","../src/Case.js","../src/CaseBase.js","../src/CBRPlayer.js","../src/dbs/MemoryCaseBase.js","../src/__epilogue__.js","../src/dbs/SQLiteCaseBase.js","../src/games/tictactoe.js"],"names":["__init__","base","Sermat","ludorum","declare","unimplemented","objects","raise","Randomness","raiseIf","Iterable","iterable","Future","exports","__package__","__name__","__dependencies__","__SERMAT__","include","dbs","games","Case","constructor","props","this","count","ply","features","actions","results","static fromGame","addResult","result","r","p","Array","isArray","length","merge","_case","identifier","join","JSON","stringify","record","obj","id","forEach","f","i","static fromRecord","k","substr","parse","static __SERMAT__","serializer","CaseBase","params","game","random","DEFAULT","distance","features1","features2","zip","mapApply","f1","f2","isNaN","Math","abs","sum","addCase","addMatch","match","options","cdb","retainThreshold","run","then","entry","history","moves","fromGame","state","addMatches","matches","matchCount","intervalId","logger","setInterval","info","logTime","sequence","clearInterval","populate","n","trainer","players","RandomPlayer","name","matchups","tournaments","Measurement","__matches__","toArray","range","ceil","product","Match","cases","nn","cb","map","d","c","min","sorted","c1","c2","slice","closestDistance","closest","Infinity","actionEvaluations","role","roleIndex","indexOf","move","toObject","knn","forEachApply","ev","m","Object","values","gameEvaluation","encoding","hasOwnProperty","CBRPlayer","Player","call","caseBase","checkMoves","movesFor","perform","push","decision","choice","action","t","minEval","positiveActions","filter","negativeActions","weightedChoice","normalizeWeights","assess","cbrPlayer","evaluation","player","finishedMatchesCount","tuple","matchPlayers","repeat","playerIndex","playerRole","MemoryCaseBase","__cases__","__index__","SQLiteCaseBase","__setupDatabase__","Database","require","db","__db__","toLowerCase","pragma","__tableName__","tableName","__createTable__","actionColumns","resultColumns","featureColumns","_","__runSQL__","sql","args","prototype","arguments","stmt","prepare","apply","err","Error","__getSQL__","all","fields","keys","changes","sets","fromRecord","bind","__nn_sql__","v","row","serialize_CaseBase","TicTacToe","DirectCase","board","split","chr"],"mappings":"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","file":"ludorum-player-cbr-tag.min.js","sourcesContent":["/** Package wrapper and layout.\n*/\nfunction __init__(base, Sermat, ludorum) { \"use strict\";\n// Import synonyms. ////////////////////////////////////////////////////////////////////////////////\n\tvar declare = base.declare,\n\t\tunimplemented = base.objects.unimplemented,\n\t\traise = base.raise,\n\t\traiseIf = base.raiseIf,\n\t\tRandomness = base.Randomness,\n\t\tIterable = base.Iterable,\n\t\titerable = base.iterable,\n\t\tFuture = base.Future;\n\n// Library layout. /////////////////////////////////////////////////////////////////////////////////\n\tvar exports = {\n\t\t\t__package__: 'ludorum-player-cbr',\n\t\t\t__name__: 'ludorum_player_cbr',\n\t\t\t__init__: __init__,\n\t\t\t__dependencies__: [base, Sermat, ludorum],\n\t\t\t__SERMAT__: { include: [base, ludorum] },\n\n\t\t\tdbs: { /* Namespace for different types of case bases. */ },\n\t\t\tgames: { /* Namespace for functions and definitions for supporting games. */ }\n\t\t},\n\t\tdbs = exports.dbs,\n\t\tgames = exports.games\n\t;\n","/** # Case\n\nTODO\n*/\nvar Case = exports.Case = declare({\n\t/** The `props` argument must have:\n\t\n\t+ `count`: the amount of times this case has been seen,\n\t+ `ply`: a number with the average ply where this case happens,\n\t+ `features`: an array of numbers representing the relevant information of the case,\n\t+ `actions`: an object mapping players to actions,\n\t+ `results`: an object mapping players to a 3 number array with the counts for: victories, \n\tdraws and defeats.\n\t*/\n\tconstructor: function Case(props) {\n\t\tthis.count = +props.count || 1;\n\t\tthis.ply = +props.ply;\n\t\tthis.features = props.features;\n\t\tthis.actions = props.actions;\n\t\tthis.results = props.results;\n\t},\n\n\t/** TODO \n\t*/\n\t'static fromGame': base.objects.unimplemented('Case', 'fromGame(game, ply, moves)'),\n\n\t/** TODO \n\t*/\n\taddResult: function addResult(result) {\n\t\tvar r;\n\t\tfor (var p in result) {\n\t\t\tr = result[p];\n\t\t\tif (Array.isArray(r) && r.length === 3) { // case results\n\t\t\t\tthis.results[p][0] += result[p][0];\n\t\t\t\tthis.results[p][1] += result[p][1];\n\t\t\t\tthis.results[p][2] += result[p][2];\n\t\t\t} else if (typeof r === 'number') {\n\t\t\t\tthis.results[p][r > 0 ? 0 : r === 0 ? 1 : 2]++;\n\t\t\t} else {\n\t\t\t\traise('Invalid result (', r, ')!');\n\t\t\t}\n\t\t}\n\t\tthis.count = (this.count || 0) + 1; \n\t},\n\n\t/** TODO \n\t*/\n\tmerge: function merge(_case) {\n\t\tthis.ply = (this.ply * this.count + _case.ply * _case.count) / (this.count + _case.count);\n\t\tthis.count += _case.count;\n\t\tthis.addResult(_case.result);\n\t},\n\n\t/** TODO\n\t*/\n\tidentifier: function identifier() {\n\t\treturn this.features.join(',') + JSON.stringify(this.actions);\n\t},\n\n\t/** Return a database record for this case.\n\t*/\n\trecord: function record(obj) {\n\t\tobj = obj || {};\n\t\tvar p;\n\t\tobj.id = this.identifier();\n\t\tobj.ply = this.ply;\n\t\tobj.count = this.count;\n\t\tthis.features.forEach(function (f, i) {\n\t\t\tobj['f'+ i] = f;\n\t\t});\n\t\tfor (p in this.actions) {\n\t\t\tobj['a_'+ p] = JSON.stringify(this.actions[p]);\n\t\t}\n\t\tfor (p in this.results) {\n\t\t\tobj['won_'+ p] = this.results[p][0];\n\t\t\tobj['tied_'+ p] = this.results[p][1];\n\t\t\tobj['lost_'+ p] = this.results[p][2];\n\t\t}\n\t\treturn obj;\n\t},\n\n\t/** TODO\n\t*/\n\t'static fromRecord': function fromRecord(record) {\n\t\tvar features = [],\n\t\t\tactions = {},\n\t\t\tresults = {};\n\t\tfor (var k in record) {\n\t\t\tif (k[0] === 'f') {\n\t\t\t\tfeatures[+k.substr(1)] = record[k];\n\t\t\t} else if (k.substr(0, 2) === 'a_') {\n\t\t\t\tactions[k.substr(2)] = JSON.parse(record[k]);\n\t\t\t}\n\t\t}\n\t\tfor (var p in results) {\n\t\t\tresults[p] = [record['won_'+ p], record['tied_'+ p], record['lost_'+ p]];\n\t\t}\n\t\treturn new this({ \n\t\t\tcount: record.count,\n\t\t\tply: record.ply,\n\t\t\tfeatures: features,\n\t\t\tactions: actions,\n\t\t\tresults: results\n\t\t});\n\t},\n\n\t// Utilities //////////////////////////////////////////////////////////////////////////////////\n\n\t/** Serialization and materialization using Sermat.\n\t*/\n\t'static __SERMAT__': {\n\t\tidentifier: 'Case',\n\t\tserializer: function serialize_Case(obj) {\n\t\t\treturn [{\n\t\t\t\tcount: obj.count,\n\t\t\t\tply: obj.ply,\n\t\t\t\tfeatures: obj.features,\n\t\t\t\tactions: obj.actions,\n\t\t\t\tresults: obj.results\n\t\t\t}];\n\t\t}\n\t}\n}); // declare Case","/** # CaseBase \n\nA `CaseBase` holds all cases for a game.\n*/\nvar CaseBase = exports.CaseBase = declare({\n\tconstructor: function CaseBase(params) {\n\t\tthis.game = params && params.game;\n\t\tif (params && typeof params.Case === 'function') {\n\t\t\tthis.Case = params.Case;\n\t\t}\n\t\tthis.random = params && params.random || Randomness.DEFAULT;\n\t},\n\n\t/** ## Distances ########################################################################### */\n\n\t/** The default `distance` is a form of Manhattan distance, which does not count `null` or \n\t`NaN` features.\n\t*/\n\tdistance: function distance(features1, features2) {\n\t\treturn base.Iterable.zip(features1, features2).mapApply(function (f1, f2) {\n\t\t\tif (f1 !== null && !isNaN(f1) && f2 !== null && !isNaN(f2)) {\n\t\t\t\treturn Math.abs(f1 - f2);\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t}).sum();\n\t},\n\n\t/** ## Case acquisition #################################################################### */\n\n\t/** Adding a case to the database is not implemented by default.\n\t*/\n\taddCase: unimplemented('CaseBase', 'addCase(_case)'),\n\n\t/** The `addMatch` method runs the given `match` and adds all its game states as cases in the\n\tdatabase. It returns a promise.\n\t*/\n\taddMatch: function addMatch(match, options) {\n\t\tvar cdb = this,\n\t\t\tretainThreshold = +options.retainThreshold || 0;\n\t\treturn match.run().then(function () {\n\t\t\tvar result = match.result(),\n\t\t\t\thistory = match.history,\n\t\t\t\tentry, _case, breakStoring;\n\t\t\tfor (var i = history.length - 1; i >= 0; i--) {\n\t\t\t\tentry = history[i];\n\t\t\t\tif (entry.moves) {\n\t\t\t\t\tcdb.Case.fromGame(entry.state, i, entry.moves).forEach(function (_case) {\n\t\t\t\t\t\t_case.addResult(result);\n\t\t\t\t\t\tcdb.addCase(_case);\n\t\t\t\t\t});\n\t\t\t\t\t//FIXME\n\t\t\t\t\t// breakStoring = retainThreshold !== 0 && retainThreshold > cdb.closestDistance(entry.state);\n\t\t\t\t\t// cdb.addCase(_case);\n\t\t\t\t\t// if (breakStoring) {\n\t\t\t\t\t//\tbreak;\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn match;\n\t\t});\n\t},\n\n\t/** The `addMatches` method takes a sequence of `matches`, runs each in order and adds all \n\tresulting game states to the database. It returns a promise.\n\t*/\n\taddMatches: function addMatches(matches, options) {\n\t\tvar cdb = this,\n\t\t\tmatchCount = 0,\n\t\t\tintervalId = 0;\n\t\tif (options.logger) {\n\t\t\tintervalId = setInterval(function () {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}, options.logTime || 30000);\n\t\t}\n\t\treturn Future.sequence(matches, function (match) {\n\t\t\tmatchCount++;\n\t\t\treturn cdb.addMatch(match, options);\n\t\t}).then(function (r) {\n\t\t\tif (options.logger) {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}\n\t\t\tclearInterval(intervalId);\n\t\t\treturn r;\n\t\t});\n\t},\n\n\t/** The `populate` method adds cases to the database by running several matches and adding the\n\tresulting game states. The `options` argument may include the following:\n\n\t+ `game`: The game state from which to start the matches. The database's `game` is used by \n\tdefault.\n\n\t+ `n`: The number of matches to run; 100 by default.\n\n\t+ `trainer`: The player to use agains the opponents. A random player is used by default.\n\n\t+ `players`: The trainer's opponents to use to play the matches. The trainer is used by default.\n\n\tOther options are passed to the `addMatches` method. The result is a promise.\n\t*/\n\tpopulate: function populate(options) {\n\t\toptions = options || {};\n\t\tvar cdb = this,\n\t\t\tgame = options.game || this.game,\n\t\t\tn = isNaN(options.n) ? 100 : +options.n,\n\t\t\ttrainer = options.trainer || new ludorum.players.RandomPlayer({ name: 'RandomPlayer' }),\n\t\t\tplayers = options.players || [trainer];\n\t\tif (!Array.isArray(players)) {\n\t\t\tplayers = [players];\n\t\t}\n\t\tvar tournament = new ludorum.tournaments.Measurement(game, trainer, players, 1),\n\t\t\tmatchups = tournament.__matches__().toArray();\n\t\treturn this.addMatches(Iterable.range(Math.ceil(n / matchups.length))\n\t\t\t.product(matchups)\n\t\t\t.mapApply(function (i, match) {\n\t\t\t\treturn new ludorum.Match(game, match.players);\n\t\t\t}), options);\n\t},\n\n\t/** ## Database use ######################################################################## */\n\n\t/** The `cases` method returns the sequence of all cases in the database. Case order is not\n\tdefined.\n\t*/\n\tcases: unimplemented('CaseBase', 'cases(filters)'),\n\n\t/** The `nn` method returns the `k` neareast neighbours of the given game state. \n\t*/\n\tnn: function nn(k, game) {\n\t\tvar cb = this,\n\t\t\tcases = iterable(this.Case.fromGame(game)),\n\t\t\tcs = iterable(this.cases()).map(function (_case) {\n\t\t\t\tvar d = cases.map(function (c) {\n\t\t\t\t\treturn cb.distance(_case.features, c.features);\n\t\t\t\t}).min();\n\t\t\t\treturn [_case, d];\n\t\t\t}).sorted(function (c1, c2) {\n\t\t\t\treturn c1[1] - c2[1];\n\t\t\t}).toArray();\n\t\treturn cs.slice(0, +k);\n\t},\n\n\t/** The `closestDistance` method returns the distance to the closest case in the case base from\n\tthe given game state.\n\t*/\n\tclosestDistance: function closestDistance(game) {\n\t\tvar closest = this.nn(1, game);\n\t\treturn closest.length === 0 ? Infinity : closest[0][1];\n\t},\n\n\t/**TODO\n\t*/\n\tactionEvaluations: function actionEvaluations(game, role, options) {\n\t\tvar cb = this,\n\t\t\tk = options && +options.k || 10,\n\t\t\troleIndex = game.players.indexOf(role),\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = cb.nn(k, game);\n\t\titerable(knn).forEachApply(function (_case, distance) {\n\t\t\tvar m = r[JSON.stringify(_case.actions[roleIndex])],\n\t\t\t\tresult = _case.results[role],\n\t\t\t\tev, support, ratio;\n\t\t\tif (m) {\n\t\t\t\tsupport = _case.count / (10 + _case.count);\n\t\t\t\tratio = (result[0] + result[2] && \n\t\t\t\t\t((result[0] - result[2]) / (result[0] + result[2])));\n\t\t\t\tev = support * ratio * (1 / (1 + distance));\n\t\t\t\tif (isNaN(ev)) {\n\t\t\t\t\traise(\"Action evaluation is NaN for case: \", JSON.stringify(_case),\n\t\t\t\t\t\t\" (distance= \", distance, \")!\");\n\t\t\t\t}\n\t\t\t\tm[1] += ev;\n\t\t\t}\n\t\t});\n\t\treturn Object.values(r);\n\t},\n\n\t/**TODO\n\t*/\n\tgameEvaluation: function gameEvaluation(game, role, options) { //FIXME\n\t\tvar cb = this,\n\t\t\tk = options && +options.k || 10,\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = cb.nn(k, game, role);\n\t\treturn iterable(knn).map(function (_case, distance) {\n\t\t\treturn (_case.results[role][0] - _case.results[role][2]) / (1 + distance);\n\t\t}).sum();\n\t},\n\n\t/** ## Utilities ########################################################################### */\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'CaseBase',\n\t\tserializer: function serialize_CaseBase(obj) { //FIXME\n\t\t\treturn [{\n\t\t\t\tgame: obj.game,\n\t\t\t\tencoding: obj.hasOwnProperty('encoding') ? obj.encoding : null\n\t\t\t}];\n\t\t}\n\t},\n}); // declare CaseBase","/** # CBR Player \n\n*/\nvar CBRPlayer = exports.CBRPlayer = base.declare(ludorum.Player, {\n\t/** \n\t*/\n\tconstructor: function CBRPlayer(params) {\n\t\tludorum.Player.call(this, params);\n\t\tthis.caseBase = params && params.caseBase;\n\t\tthis.k = params && params.k || 20;\n\t},\n\n\t/** \n\t*/\n\tcheckMoves: function checkMoves(game, role) {\n\t\tvar r = [[], []];\n\t\tthis.movesFor(game, role).forEach(function (move) {\n\t\t\tvar game2 = game.perform(move, role),\n\t\t\t\tresult = game2.result();\n\t\t\tif (!result) {\n\t\t\t\tr[1].push(move); // Not a losing move.\n\t\t\t} else if (result[role] > 0) {\n\t\t\t\tr[0].push(move); // Winning move.\n\t\t\t}\n\t\t});\n\t\treturn r;\n\t},\n\n\t/** A `CBRPlayer` takes the action evaluations from the case base, and splits them into actions\n\twith possitive evaluations and the ones with evaluations less than or equal to zero. If there\n\tare possitively evaluated actions, one of these is chosen randomly with a probability \n\tproportional to the evaluation. If all actions have non possitive evaluations, one of these is\n\tchosen with a probability inversely proportional to the evaluation.   \n\t*/\n\tdecision: function decision(game, role) {\n\t\tvar checkMoves = this.checkMoves(game, role);\n\t\tif (checkMoves[0].length > 0) {\n\t\t\treturn this.random.choice(checkMoves[0]);\n\t\t} else if (checkMoves[1].length < 2) {\n\t\t\tif (checkMoves[1].length === 1) {\n\t\t\t\treturn checkMoves[1][0];\n\t\t\t} else { // if (checkMoves[1].length < 1)\n\t\t\t\treturn this.random.choice(this.movesFor(game, role));\n\t\t\t}\n\t\t}\n\t\tvar actions = iterable(checkMoves[1]).map(function (action) {\n\t\t\t\treturn [action +'', [action, 0]];\n\t\t\t}).toObject();\n\t\tthis.caseBase.actionEvaluations(game, role, { k: this.k }).forEach(function (t) {\n\t\t\tvar entry = actions[t[0] +''];\n\t\t\tif (entry) {\n\t\t\t\tentry[1] += t[1];\n\t\t\t}\n\t\t});\n\t\tvar minEval = +Infinity,\n\t\t\tpositiveActions = Object.values(actions).filter(function (t) {\n\t\t\t\tminEval = Math.min(minEval, t[1]);\n\t\t\t\treturn t[1] > 0;\n\t\t\t}),\n\t\t\tnegativeActions = Object.values(actions).filter(function (t) {\n\t\t\t\treturn t[1] <= 0;\n\t\t\t}).map(function (t) {\n\t\t\t\treturn [t[0], t[1] - minEval];\n\t\t\t}),\n\t\t\tresult;\n\t\tif (positiveActions.length > 1) {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(positiveActions));\n\t\t} else if (positiveActions.length === 1) {\n\t\t\tresult = positiveActions[0][0];\n\t\t} else {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(negativeActions));\n\t\t}\n\t\treturn result;\n\t},\n\n\t// Utilities. /////////////////////////////////////////////////////////////////////////////////\n\n\tassess: function assess(players, options) {\n\t\tif (!Array.isArray(players)) {\n\t\t\tplayers = [players];\n\t\t}\n\t\tvar cbrPlayer = this,\n\t\t\tgame = this.caseBase.game,\n\t\t\tevaluation = iterable(players).map(function (player) {\n\t\t\t\treturn [player.name, iterable(game.players).map(function (p) {\n\t\t\t\t\t\treturn [p, [0,0,0]];\n\t\t\t\t\t}).toObject()];\n\t\t\t\t}).toObject(),\n\t\t\tn = options && +options.n || 300,\n\t\t\tfinishedMatchesCount = 0,\n\t\t\tintervalId = 0;\n\t\tif (options.logger) {\n\t\t\tintervalId = setInterval(function () {\n\t\t\t\toptions.logger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t\t}, options.logTime || 30000);\n\t\t}\n\t\treturn base.Future.sequence(base.Iterable.range(n).product(players), function (tuple) {\n\t\t\tvar player = tuple[1],\n\t\t\t\tmatchPlayers = base.Iterable.repeat(player, game.players.length).toArray(),\n\t\t\t\tplayerIndex = tuple[0] % game.players.length,\n\t\t\t\tplayerRole = game.players[playerIndex];\n\t\t\tmatchPlayers[playerIndex] = cbrPlayer;\n\t\t\tvar match = new ludorum.Match(game, matchPlayers);\n\t\t\treturn match.run().then(function () {\n\t\t\t\tvar r = match.result()[playerRole];\n\t\t\t\tevaluation[player.name][playerRole][r > 0 ? 0 : r < 0 ? 2 : 1]++;\n\t\t\t\tfinishedMatchesCount++;\n\t\t\t});\n\t\t}).then(function () {\n\t\t\tclearInterval(intervalId);\n\t\t\tif (options.logger) {\n\t\t\t\toptions.logger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t\t}\n\t\t\treturn evaluation;\n\t\t});\n\t}\n}); // declare CBRPlayer","/** # MemoryCaseBase\n\nA memory implementation of a `CaseBase`.\n*/\nvar MemoryCaseBase = dbs.MemoryCaseBase = declare(CaseBase, {\n\tconstructor: function MemoryCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__cases__ = [];\n\t\tthis.__index__ = {};\n\t},\n\n\tcases: function cases() {\n\t\treturn base.iterable(this.__cases__);\n\t},\n\t\n\taddCase: function addCase(_case) {\n\t\tvar id = _case.identifier();\n\t\tif (this.__index__[id]) {\n\t\t\tvar storedCase = this.__cases__[this.__index__[id]];\n\t\t\tstoredCase.merge(_case);\n\t\t} else {\n\t\t\tvar i = this.__cases__.push(_case) - 1;\n\t\t\tthis.__index__[id] = i;\n\t\t}\n\t},\n\n\t/** ## Utilities ########################################################################### */\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'MemoryCaseBase',\n\t\tserializer: function serialize_MemoryCaseBase(obj) {\n\t\t\treturn null; //FIXME\n\t\t}\n\t},\n}); // declare MemoryCaseBase","// See __prologue__.js\n\treturn exports;\n}\n","/** # SQLiteCaseBase\n\nAn implementation of a `CaseBase` using SQLite3 through `better-sqlite3`.\n*/\ndbs.SQLiteCaseBase = declare(CaseBase, {\n\t/** \n\t*/\n\tconstructor: function SQLiteCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__setupDatabase__(params);\n\t},\n\n\t/** ## Database setup and management ####################################################### */\n\n\t/**\n\t*/\n\t__setupDatabase__: function __setupDatabase__(params) {\n\t\tvar game = this.game,\n\t\t\tDatabase = this.Database || require('better-sqlite3');\n\t\tif (params.db instanceof Database) {\n\t\t\tthis.__db__ = params.db;\n\t\t} else {\n\t\t\tthis.__db__ = new Database(typeof params.db === 'string' ? params.db : \n\t\t\t\t'./'+ game.name.toLowerCase() +'-cbr.sqlite');\n\t\t\tthis.__db__.pragma('journal_mode = OFF'); // Disable transactions.\n\t\t\tthis.__db__.pragma('cache_size = -128000'); // Increase default cache size.\n\t\t\tthis.__db__.pragma('encoding = \"UTF-8\"'); // Increase default cache size.\n\t\t}\n\t\t\n\t\tthis.__tableName__ = params.tableName || 'CB_'+ game.name;\n\t\tthis.__createTable__();\n\t},\n\n\t__createTable__: function __createTable__(tableName, game) {\n\t\ttableName = tableName || this.__tableName__;\n\t\tgame = game || this.game;\n\t\tvar _case = this.Case.fromGame(game)[0],\n\t\t\tactionColumns = game.players.map(function (p) {\n\t\t\t\treturn 'a_'+ p +' TEXT';\n\t\t\t}).join(', '),\n\t\t\tresultColumns = game.players.map(function (p) {\n\t\t\t\treturn 'won_'+ p +' INTEGER, tied_'+ p +' INTEGER, lost_'+ p +' INTEGER';\n\t\t\t}).join(', '),\n\t\t\tfeatureColumns = _case.features.map(function (_, i) {\n\t\t\t\treturn 'f'+ i +' INTEGER';\n\t\t\t}).join(', ');\n\t\treturn this.__runSQL__('CREATE TABLE IF NOT EXISTS '+ tableName +\n\t\t\t'(id TEXT PRIMARY KEY, count INTEGER, ply REAL, '+\n\t\t\tactionColumns +', '+ resultColumns +', '+ featureColumns +')');\n\t},\n\n\t__runSQL__: function __runSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.run.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error executing `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t__getSQL__: function __getSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.all.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error querying `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t/** ## Cases ############################################################################### */\n\n\taddCase: function addCase(_case) {\n\t\tvar players = this.game.players,\n\t\t\trecord = _case.record(),\n\t\t\tfields = Object.keys(record),\n\t\t\tsql = 'INSERT OR IGNORE INTO '+ this.__tableName__ +' ('+ fields.join(',') +\n\t\t\t\t') VALUES ('+ Iterable.repeat('?', fields.length).join(',') +')',\n\t\t\tisNew = this.__runSQL__(sql, fields.map(function (f) {\n\t\t\t\t\treturn record[f];\n\t\t\t\t})).changes > 0;\n\t\tif (!isNew) { // Insert was ignored because the case is already stored.\n\t\t\tthis.__runSQL__('UPDATE '+ this.__tableName__ +' '+\n\t\t\t\t'SET count = count + 1, ply = (ply * count + '+ (_case.ply || 0) +') / (count + 1), '+\n\t\t\t\tplayers.map(function (p) {\n\t\t\t\t\tvar r = _case.results[p],\n\t\t\t\t\t\tsets = [];\n\t\t\t\t\tif (r[0]) {\n\t\t\t\t\t\tsets.push('won_'+ p +' = won_'+ p +' + '+ r[0]);\n\t\t\t\t\t}\n\t\t\t\t\tif (r[1]) {\n\t\t\t\t\t\tsets.push('tied_'+ p +' = tied_'+ p +' + '+ r[1]);\n\t\t\t\t\t}\n\t\t\t\t\tif (r[2]) {\n\t\t\t\t\t\tsets.push('lost_'+ p +' = lost_'+ p +' + '+ r[2]);\n\t\t\t\t\t}\n\t\t\t\t\treturn sets.join(', ');\n\t\t\t\t}).join(', ') +' WHERE id = \\''+ record.id +'\\''\n\t\t\t);\n\t\t}\n\t},\n\n\tcases: function cases() {\n\t\treturn this.__getSQL__('SELECT * FROM '+ this.__tableName__)\n\t\t\t.map(this.Case.fromRecord.bind(this.Case));\n\t},\n\n\t__nn_sql__: function __nn_sql__(k, game) {\n\t\tvar cases = this.Case.fromGame(game);\n\t\treturn 'SELECT *, min('+ cases.map(function (_case) {\n\t\t\t\treturn _case.features.map(function (v, i) {\n\t\t\t\t\treturn v !== null && !isNaN(v) ? 'abs(ifnull(f'+ i +'-('+ v +'),0))' : '0';\n\t\t\t\t}).join('+');\n\t\t\t}).join(', ') +') AS distance '+\n\t\t\t'FROM '+ this.__tableName__ +' '+\n\t\t\t'ORDER BY distance ASC LIMIT '+ k;\n\t},\n\n\tnn: function nn(k, game) {\n\t\tvar cb = this,\n\t\t\tsql = this.__nn_sql__(k, game);\n\t\treturn this.__db__.prepare(sql).all().map(function (row) {\n\t\t\treturn [cb.Case.fromRecord(row), row.distance];\n\t\t});\n\t},\n\n\t// Utilities //////////////////////////////////////////////////////////////////////////////////\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'SQLiteCaseBase',\n\t\tserializer: function serialize_SQLiteCaseBase(obj) {\n\t\t\treturn CaseBase.__SERMAT__.serialize_CaseBase(obj);\n\t\t}\n\t},\n}); // declare SQLiteCaseBase\n\n","/**\n \n*/\ngames.TicTacToe = {\n\tDirectCase: declare(Case, {\n\t\t/**\n\t\t \n\t\t*/\n\t\t'static fromGame': function fromGame(game, ply, moves) {\n\t\t\tvar features = game.board.split('').map(function (chr) {\n\t\t\t\t\treturn chr === 'X' ? (+1) : chr === 'O' ? (-1) : 0; \n\t\t\t\t}),\n\t\t\t\tactions = iterable(game.players).map(function (p) {\n\t\t\t\t\treturn [p, moves && moves.hasOwnProperty(p) ? moves[p] : null];\n\t\t\t\t}).toObject(),\n\t\t\t\tresults = iterable(game.players).map(function (p) {\n\t\t\t\t\treturn [p, [0, 0, 0]];\n\t\t\t\t}).toObject(),\n\t\t\t\t_case = new this({\n\t\t\t\t\tply: +ply,\n\t\t\t\t\tfeatures: features,\n\t\t\t\t\tactions: actions,\n\t\t\t\t\tresults: results\n\t\t\t\t});\n\t\t\treturn [_case];\n\t\t}\n\n\t})\n}; // declare TicTacToe.DirectCase"]}