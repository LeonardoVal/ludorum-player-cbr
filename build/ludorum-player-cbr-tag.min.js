//! ludorum-player-cbr 0.0.1

(function(a){"use strict";this["ludorum-player-cbr"]=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";var e=b.declare,f=b.objects.unimplemented,g=(b.raise,b.raiseIf,b.Randomness),h=b.Iterable,i=(b.iterable,b.Future),j={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b,d]},dbs:{}},k=j.CaseBase=b.declare({constructor:function(a){this.game=a&&a.game,a&&"function"==typeof a.encoding&&(this.encoding=a.encoding),this.random=a&&a.random||g.DEFAULT},encoding:f("CaseBase","encoding(game, moves, ply)"),distance:function(a,c){return b.Iterable.zip(a,c).mapApply(function(a,b){return null===n1||isNaN(n1)||null===n2||isNaN(n2)?0:Math.abs(n1-n2)}).sum()},addCase:f("CaseBase","addCase(_case)"),addMatch:function(a,b){var c=this;return a.run().then(function(){var b=a.result(),d=0;return c.game.players.forEach(function(a){b[a]=[b[a]>0?1:0,0===b[a]?1:0,b[a]<0?1:0]}),a.history.forEach(function(a){if(a.moves){var e=c.encoding(a.state,a.moves,d);d++,e.result=b,c.addCase(e)}}),a})},addMatches:function(a,b){var c=this;return i.sequence(a,function(a){return c.addMatch(a,b)})},populate:function(a){a=a||{};var b=a.game||this.game,c=a.n||100,e=a.players||[new d.players.RandomPlayer],f=h.product.apply(h,h.repeat(e,b.players.length).toArray()).toArray();return this.addMatches(h.range(Math.ceil(c/f.length)).product(f).mapApply(function(a,c){return new d.Match(b,c)}),a)},cases:f("CaseBase","cases()"),nn:function(a,b){var c=this,d=(this.encoding(b),this.cases().map(function(a,b){return[a,c.distance(a.features,b.features)]}).sorted(function(a,b){return a[1]-b[1]}));return d.slice(0,+a)},"static __SERMAT__":{identifier:"CaseBase",serializer:function(a){return[{game:a.game,encoding:a.hasOwnProperty("encoding")?a.encoding:null}]}}});j.CBRPlayer=b.declare(d.Player,{constructor:function(a){d.Player.call(this,a),this.caseDB=a&&a.caseDB,this.caseN=a&&a.caseN||20},evaluatedMoves:function(a,c){var d=this.caseDB,e=b.iterable(this.movesFor(a,c)).map(function(a){return[a+"",[a,0]]}).toObject();return b.iterable(d.knn(this.caseN,a,c)).forEach(function(a){var b=e[a.actions[c]];b&&(b[1]+=(a.result[c][0]-a.result[c][2])/a.count)}),Object.values(e)},decision:function(a,c){var d,e=this.evaluatedMoves(a,c),f=b.iterable(e).greater(function(a){return a[1]}).map(function(a){return d=a[1],a[0]});return b.raiseIf(!f||!f.length,"No moves where selected at ",a," for player ",c,"!"),1===f.length?f[0]:b.Randomness.DEFAULT.choice(f)},assess:function(a,c,e){var f=this,g=b.iterable(a.players).map(function(a){return[a,[0,0,0]]}).toObject(),h=b.Iterable.repeat(c,a.players.length).toArray();return e=+e||100,b.Future.sequence(b.Iterable.range(e),function(b){var c=h.slice(),e=b%a.players.length,i=a.players[e];c[e]=f;var j=new d.Match(a,c);return j.run().then(function(){var a=j.result()[i];g[i][a>0?0:a<0?2:1]++})}).then(function(){return g})}}),j.dbs.MemoryCaseBase=e(k,{constructor:function(a){k.call(this,a),this.__cases__=[]},cases:function(){return b.iterable(this.__cases__)},addCase:function(a){var b={features:c.clone(a.features||null),actions:c.clone(a.actions||null),result:c.clone(a.result||null)};return this.__cases__.push(b)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(a){return k.__SERMAT__.serialize_CaseBase(a)}}});return j.dbs.SQLiteCaseBase=b.declare(k,{constructor:function(a){k.call(this,a),this.__setupDatabase__(a)},__setupDatabase__:function(a){var c=this.game,d=this.Database||require("better-sqlite3");this.__db__=new d(a.dbpath||"./"+c.name.toLowerCase()+"-cbr.sqlite");var e=this.encoding(c,c.moves()),f=e.features.map(function(a,b){return"f"+b}),g=c.players.map(function(a,b){return"a"+b}),h=b.Iterable.range(c.players.length).product(["won","tied","lost"]).mapApply(function(a,b){return b+a}).toArray(),i=f.concat(g).concat(h),j="CREATE TABLE IF NOT EXISTS Cases (key TEXT PRIMARY KEY, count INTEGER, "+i.map(function(a){return a+" INTEGER"}).join(", ")+")";this.__db__.prepare(j).run(),this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__distanceFunction__:function(a){a=a||this.distance;var b=[],c=[];return function(){for(var d=arguments.length/2|0,e=0;e<d;e++)b.push(arguments[e]),c.push(arguments[d+e]);return a(b,c)}},__key__:function(a){var b=a.features,c=a.actions||this.game.players.map(function(){return null});return b.join(",")+":"+c.join(",")},addCase:function(a){var c=this.game.players,d=this.__key__(a),e="INSERT OR IGNORE INTO Cases VALUES ("+["'"+d+"'",0].concat(a.features.map(JSON.stringify)).concat(a.actions.map(JSON.stringify)).concat(b.Iterable.repeat(0,3*c.length).toArray()).join(",")+")";this.__db__.prepare(e).run(),e="UPDATE Cases SET count = count + 1, "+c.map(function(b){var d=a.result[b],e=c.indexOf(b);return"won"+e+" = won"+e+" + "+d[0]+", tied"+e+" = tied"+e+" + "+d[1]+", lost"+e+" = lost"+e+" + "+d[2]}).join(", "),this.__db__.prepare(e).run()},knn:function(a,c,d){var e=c.players.indexOf(d),f=this.encoding(c),g=this.__db__.prepare("SELECT *, distance("+f.features.map(function(a,b){return"f"+b}).join(", ")+", "+f.features.join(", ")+") AS d FROM Cases WHERE a"+e+" IS NOT NULL ORDER BY d LIMIT "+a).all();return g.map(function(a){return{count:a.count,features:f.features.map(function(b,c){return a["f"+c]}),actions:b.iterable(c.players).map(function(b,c){return[b,a["a"+c]]}).toObject(),result:b.iterable(c.players).map(function(b,c){return[b,[a["won"+c],a["tied"+c],a["lost"+c]]]}).toObject(),distance:a.d}})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(a){return k.__SERMAT__.serialize_CaseBase(a)}}}),j.encodingTicTacToe=function(a,b){return{features:a.board.split("").map(function(a){return"X"===a?0:"O"===a?1:.5}),actions:b?a.players.map(function(a){return b.hasOwnProperty(a)?b[a]:null}):null}},j});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map