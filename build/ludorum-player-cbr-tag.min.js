//! ludorum-player-cbr 0.0.1

(function(e){"use strict";this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(c,n,l){"use strict";var t=c.declare,a=c.objects.unimplemented,r=(c.raise,c.raiseIf,c.Randomness),i=c.Iterable,u=c.iterable,s=c.Future,o={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[c,n,l],__SERMAT__:{include:[c,l]},dbs:{},utils:{}},_=o.CaseBase=c.declare({constructor:function(e){this.game=e&&e.game,e&&"function"==typeof e.encoding&&(this.encoding=e.encoding),e&&"function"==typeof e.distance&&(this.distance=e.distance),this.random=e&&e.random||r.DEFAULT},encoding:a("CaseBase","encoding(game, moves, ply)"),distance:function(e,t){return c.Iterable.zip(e,t).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},addCase:a("CaseBase","addCase(_case)"),addMatch:function(e,t){var r=this;return e.run().then(function(){var a=e.result();return r.game.players.forEach(function(e){a[e]=[0<a[e]?1:0,0===a[e]?1:0,a[e]<0?1:0]}),e.history.forEach(function(e,t){if(e.moves){var n=r.encoding(e.state,e.moves,t);n.result=a,r.addCase(n)}}),e})},addMatches:function(e,t){var n=this,a=0;return s.sequence(e,function(e){return a++,t.logger&&a%10==0&&t.logger.info("Added "+a+" matches."),n.addMatch(e,t)})},populate:function(e){var n=(e=e||{}).game||this.game,t=isNaN(e.n)?100:+e.n,a=e.players||[new l.players.RandomPlayer],r=i.product.apply(i,i.repeat(a,n.players.length).toArray()).toArray();return this.addMatches(i.range(Math.ceil(t/r.length)).product(r).mapApply(function(e,t){return new l.Match(n,t)}),e)},cases:a("CaseBase","cases(filters)"),nn:function(e,t){var n=this,a=this.encoding(t);return u(this.cases()).map(function(e){return[e,n.distance(e.features,a.features)]}).sorted(function(e,t){return e[1]-t[1]}).toArray().slice(0,+e)},actionEvaluations:function(e,r,t){var n=t&&+t.k||10,s=e.players.indexOf(r),i=c.iterable(e.moves()[r]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),a=this.nn(n,e);return u(a).forEachApply(function(e,t){var n,a=i[JSON.stringify(e.actions[s])];a&&(n=e.result[r][0]+e.result[r][1]+e.result[r][2],a[1]+=n*(e.result[r][0]-e.result[r][2])/(10+n)/(1+t))}),Object.values(i)},gameEvaluation:function(e,n,t){var a=t&&+t.k||10,r=(c.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),this.nn(a,e,n));return u(r).map(function(e,t){return(e.result[n][0]-e.result[n][2])/(1+t)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(e){return[{game:e.game,encoding:e.hasOwnProperty("encoding")?e.encoding:null}]}}});o.CBRPlayer=c.declare(l.Player,{constructor:function(e){l.Player.call(this,e),this.caseBase=e&&e.caseBase,this.k=e&&e.k||20},decision:function(e,t){var n=u(this.movesFor(e,t)).map(function(e){return[e+"",[e,0]]}).toObject();this.caseBase.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=n[e[0]+""];t&&(t[1]+=e[1])});var a=1/0,r=Object.values(n).filter(function(e){return a=Math.min(a,e[1]),0<e[1]}),s=Object.values(n).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-a]});return 1<r.length?this.random.weightedChoice(this.random.normalizeWeights(r)):1===r.length?r[0][0]:this.random.weightedChoice(this.random.normalizeWeights(s))},assess:function(e,s){var i=this,u=this.caseBase.game,o=c.iterable(u.players).map(function(e){return[e,[0,0,0]]}).toObject(),_=c.Iterable.repeat(e,u.players.length).toArray(),t=s&&+s.n||150;return c.Future.sequence(c.Iterable.range(t),function(t){var e=_.slice(),n=t%u.players.length,a=u.players[n];e[n]=i;var r=new l.Match(u,e);return r.run().then(function(){s.logger&&0<t&&t%10==0&&s.logger.info("Assessment ran "+t+" matches.");var e=r.result()[a];o[a][0<e?0:e<0?2:1]++})}).then(function(){return o})}});o.dbs.MemoryCaseBase=t(_,{constructor:function(e){_.call(this,e),this.__cases__=[]},cases:function(){return c.iterable(this.__cases__)},addCase:function(e){var t={features:n.clone(e.features||null),actions:n.clone(e.actions||null),result:n.clone(e.result||null)};return this.__cases__.push(t)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return _.__SERMAT__.serialize_CaseBase(e)}}});return o.dbs.SQLiteCaseBase=c.declare(_,{constructor:function(e){_.call(this,e),this.__setupDatabase__(e)},__setupDatabase__:function(e){var t=this.game,n=this.Database||require("better-sqlite3");this.__db__=new n(e.dbpath||"./"+t.name.toLowerCase()+"-cbr.sqlite"),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"'),this.__tableName__=e.tableName||"CB_"+t.name;var a=this.encoding(t,t.moves());this.__featureColumns__=a.features.map(function(e,t){return"f"+t}),this.__actionColumns__=t.players.map(function(e,t){return"a"+t}),this.__resultColumns__=c.Iterable.range(t.players.length).product(["won","tied","lost"]).mapApply(function(e,t){return t+e}).toArray();var r="CREATE TABLE IF NOT EXISTS "+this.__tableName__+"(key TEXT PRIMARY KEY, count INTEGER, ply REAL, "+this.__actionColumns__.map(function(e){return e+" TEXT"}).join(", ")+", "+this.__resultColumns__.concat(this.__featureColumns__).map(function(e){return e+" INTEGER"}).join(", ")+")";try{this.__db__.prepare(r).run()}catch(e){throw new Error("Error while creating table. SQL: `"+r+"`!")}this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__distanceFunction__:function(n){n=n||this.distance;var a=[],r=[];return function(){for(var e=arguments.length/2|0,t=0;t<e;t++)a.push(arguments[t]),r.push(arguments[e+t]);return n(a,r)}},__key__:function(e){var t=e.features,n=e.actions||this.game.players.map(function(){return null});return t.join(",")+":"+n.join(",")},addCase:function(r){var s=this.game.players,e=this.__key__(r),t="INSERT OR IGNORE INTO "+this.__tableName__+" VALUES ("+i.repeat("?",3+this.__actionColumns__.length+this.__resultColumns__.length+this.__featureColumns__.length).join(",")+")",n=this.__db__.prepare(t);0<n.run.apply(n,[e,1,r.ply].concat(r.actions.map(function(e){return null===e?null:JSON.stringify(e)})).concat(i.chain.apply(i,s.map(function(e){return r.result[e]})).toArray()).concat(r.features)).changes||(t="UPDATE "+this.__tableName__+" SET count = count + 1, ply = (ply * count + "+(r.ply||0)+") / (count + 1), "+s.map(function(e){var t=r.result[e],n=s.indexOf(e),a=[];return t[0]&&a.push("won"+n+" = won"+n+" + "+t[0]),t[1]&&a.push("tied"+n+" = tied"+n+" + "+t[1]),t[2]&&a.push("lost"+n+" = lost"+n+" + "+t[2]),a.join(", ")}).join(", ")+" WHERE key = '"+e+"'",this.__db__.prepare(t).run())},__row2case__:function(n){return{ply:n.ply,features:this.__featureColumns__.map(function(e){return n[e]}),actions:this.__actionColumns__.map(function(e){return JSON.parse(n[e])}),result:u(this.game.players).map(function(e,t){return[e,[n["won"+t],n["tied"+t],n["lost"+t]]]}).toObject()}},cases:function(e){var t="SELECT * FROM "+this.__tableName__;return this.__db__.prepare(t).all().map(this.__row2case__.bind(this))},__nn_sql__:function(e,t){var n=this.encoding(t);return"SELECT *, ("+i.zip(this.__featureColumns__,n.features).mapApply(function(e,t){return null===t||isNaN(t)?"0":"abs(ifnull("+e+"-"+t+",0))"}).join("+")+") AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+e},nn:function(e,t){var n=this,a=this.__nn_sql__(e,t);return this.__db__.prepare(a).all().map(function(e){return[n.__row2case__(e),e.distance]})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(e){return _.__SERMAT__.serialize_CaseBase(e)}}}),o.utils.encodings={TicTacToe:function(e,t,n){return{ply:n,features:e.board.split("").map(function(e){return"X"===e?1:"O"===e?2:0}),actions:t?e.players.map(function(e){return t.hasOwnProperty(e)?t[e]:null}):null}}},o});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map