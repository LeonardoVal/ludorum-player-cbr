//! ludorum-player-cbr 0.0.1

(function(e){"use strict";this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,n,r){"use strict";var a=t.declare,s=t.objects.unimplemented,i=t.raise,o=(t.raiseIf,t.Randomness),u=t.Iterable,c=t.iterable,_=t.Future,l={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[t,n,r],__SERMAT__:{include:[t,r]},dbs:{},utils:{}},h=l.CaseBase=t.declare({constructor:function(e){this.game=e&&e.game,e&&"function"==typeof e.encoding&&(this.encoding=e.encoding),e&&"function"==typeof e.distance&&(this.distance=e.distance),this.random=e&&e.random||o.DEFAULT},encoding:s("CaseBase","encoding(game, moves, ply)"),distance:function(e,n){return t.Iterable.zip(e,n).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},addCase:s("CaseBase","addCase(_case)"),addMatch:function(e,t){var n=this,r=+t.retainThreshold||0;return e.run().then(function(){var t,a,s,i=e.result(),o=e.history;n.game.players.forEach(function(e){i[e]=[i[e]>0?1:0,0===i[e]?1:0,i[e]<0?1:0]});for(var u=o.length-1;u>=0&&(!(t=o[u]).moves||((a=n.encoding(t.state,t.moves,u)).result=i,s=0!==r&&r>n.closestDistance(t.state),n.addCase(a),!s));u--);return e})},addMatches:function(e,t){var n=this,r=0,a=0;return t.logger&&(a=setInterval(function(){t.logger.info("Added "+r+" matches.")},t.logTime||3e4)),_.sequence(e,function(e){return r++,n.addMatch(e,t)}).then(function(e){return t.logger&&t.logger.info("Added "+r+" matches."),clearInterval(a),e})},populate:function(e){var t=(e=e||{}).game||this.game,n=isNaN(e.n)?100:+e.n,a=e.trainer||new r.players.RandomPlayer({name:"RandomPlayer"}),s=e.players||[a];Array.isArray(s)||(s=[s]);var i=new r.tournaments.Measurement(t,a,s,1).__matches__().toArray();return this.addMatches(u.range(Math.ceil(n/i.length)).product(i).mapApply(function(e,n){return new r.Match(t,n.players)}),e)},cases:s("CaseBase","cases(filters)"),nn:function(e,t){var n=this,r=this.encoding(t);return c(this.cases()).map(function(e){return[e,n.distance(e.features,r.features)]}).sorted(function(e,t){return e[1]-t[1]}).toArray().slice(0,+e)},closestDistance:function(e){var t=this.nn(1,e);return 0===t.length?1/0:t[0][1]},actionEvaluations:function(e,n,r){var a=r&&+r.k||10,s=e.players.indexOf(n),o=t.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),u=this.nn(a,e);return c(u).forEachApply(function(e,t){var r,a=o[JSON.stringify(e.actions[s])],u=e.result[n];a&&(r=e.count/(10+e.count)*(u[0]+u[2]&&(u[0]-u[2])/(u[0]+u[2]))*(1/(1+t)),isNaN(r)&&i("Action evaluation is NaN for case: ",JSON.stringify(e)," (distance= ",t,")!"),a[1]+=r)}),Object.values(o)},gameEvaluation:function(e,n,r){var a=r&&+r.k||10,s=(t.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),this.nn(a,e,n));return c(s).map(function(e,t){return(e.result[n][0]-e.result[n][2])/(1+t)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(e){return[{game:e.game,encoding:e.hasOwnProperty("encoding")?e.encoding:null}]}}});l.CBRPlayer=t.declare(r.Player,{constructor:function(e){r.Player.call(this,e),this.caseBase=e&&e.caseBase,this.k=e&&e.k||20},checkMoves:function(e,t){var n=[[],[]];return this.movesFor(e,t).forEach(function(r){var a=e.perform(r,t).result();a?a[t]>0&&n[0].push(r):n[1].push(r)}),n},decision:function(e,t){var n=this.checkMoves(e,t);if(n[0].length>0)return this.random.choice(n[0]);if(n[1].length<2)return 1===n[1].length?n[1][0]:this.random.choice(this.movesFor(e,t));var r=c(n[1]).map(function(e){return[e+"",[e,0]]}).toObject();this.caseBase.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=r[e[0]+""];t&&(t[1]+=e[1])});var a=1/0,s=Object.values(r).filter(function(e){return a=Math.min(a,e[1]),e[1]>0}),i=Object.values(r).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-a]});return s.length>1?this.random.weightedChoice(this.random.normalizeWeights(s)):1===s.length?s[0][0]:this.random.weightedChoice(this.random.normalizeWeights(i))},assess:function(e,n){Array.isArray(e)||(e=[e]);var a=this,s=this.caseBase.game,i=c(e).map(function(e){return[e.name,c(s.players).map(function(e){return[e,[0,0,0]]}).toObject()]}).toObject(),o=n&&+n.n||300,u=0,_=0;return n.logger&&(_=setInterval(function(){n.logger.info("Assessment finished "+u+" matches.")},n.logTime||3e4)),t.Future.sequence(t.Iterable.range(o).product(e),function(e){var n=e[1],o=t.Iterable.repeat(n,s.players.length).toArray(),c=e[0]%s.players.length,_=s.players[c];o[c]=a;var l=new r.Match(s,o);return l.run().then(function(){var e=l.result()[_];i[n.name][_][e>0?0:e<0?2:1]++,u++})}).then(function(){return clearInterval(_),n.logger&&n.logger.info("Assessment finished "+u+" matches."),i})}}),l.dbs.MemoryCaseBase=a(h,{constructor:function(e){h.call(this,e),this.__cases__=[],this.__index__={}},cases:function(){return t.iterable(this.__cases__)},addCase:function(e){var t={count:e.count||0,ply:e.ply,features:n.clone(e.features||null),actions:n.clone(e.actions||null),result:n.clone(e.result||null)};return this.__cases__.push(t)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return h.__SERMAT__.serialize_CaseBase(e)}}});return l.dbs.SQLiteCaseBase=t.declare(h,{constructor:function(e){h.call(this,e),this.__setupDatabase__(e)},__setupDatabase__:function(e){var n=this.game,r=this.Database||require("better-sqlite3");e.db instanceof r?this.__db__=e.db:(this.__db__=new r("string"==typeof e.db?e.db:"./"+n.name.toLowerCase()+"-cbr.sqlite"),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"')),this.__tableName__=e.tableName||"CB_"+n.name;var a=this.encoding(n,n.moves());this.__featureColumns__=a.features.map(function(e,t){return"f"+t}),this.__actionColumns__=n.players.map(function(e,t){return"a"+t}),this.__resultColumns__=t.Iterable.range(n.players.length).product(["won","tied","lost"]).mapApply(function(e,t){return t+e}).toArray(),this.__createTable__(),this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__createTable__:function(e,t,n,r){return e=e||this.__tableName__,t=t||this.__featureColumns__,n=n||this.__actionColumns__,r=r||this.__resultColumns__,this.__runSQL__("CREATE TABLE IF NOT EXISTS "+e+"(key TEXT PRIMARY KEY, count INTEGER, ply REAL, "+n.map(function(e){return e+" TEXT"}).join(", ")+", "+r.concat(t).map(function(e){return e+" INTEGER"}).join(", ")+")")},__runSQL__:function(e){var t=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(e);return n.run.apply(n,t)}catch(n){throw new Error("Error executing `"+e+"` "+JSON.stringify(t)+"!")}},__getSQL__:function(e){var t=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(e);return n.all.apply(n,t)}catch(n){throw new Error("Error querying `"+e+"` "+JSON.stringify(t)+"!")}},__distanceFunction__:function(e){e=e||this.distance;var t=[],n=[];return function(){for(var r=arguments.length/2|0,a=0;a<r;a++)t.push(arguments[a]),n.push(arguments[r+a]);return e(t,n)}},__key__:function(e){var t=e.features,n=e.actions||this.game.players.map(function(){return null});return t.join(",")+":"+n.join(",")},addCase:function(e){var t=this.game.players,n=this.__key__(e),r="INSERT OR IGNORE INTO "+this.__tableName__+" VALUES ("+u.repeat("?",3+this.__actionColumns__.length+this.__resultColumns__.length+this.__featureColumns__.length).join(",")+")";this.__runSQL__(r,[n,1,e.ply].concat(e.actions.map(function(e){return null===e?null:JSON.stringify(e)})).concat(u.chain.apply(u,t.map(function(t){return e.result[t]})).toArray()).concat(e.features)).changes>0||this.__runSQL__("UPDATE "+this.__tableName__+" SET count = count + 1, ply = (ply * count + "+(e.ply||0)+") / (count + 1), "+t.map(function(n){var r=e.result[n],a=t.indexOf(n),s=[];return r[0]&&s.push("won"+a+" = won"+a+" + "+r[0]),r[1]&&s.push("tied"+a+" = tied"+a+" + "+r[1]),r[2]&&s.push("lost"+a+" = lost"+a+" + "+r[2]),s.join(", ")}).join(", ")+" WHERE key = '"+n+"'")},__row2case__:function(e){return{count:e.count,ply:e.ply,features:this.__featureColumns__.map(function(t){return e[t]}),actions:this.__actionColumns__.map(function(t){return JSON.parse(e[t])}),result:c(this.game.players).map(function(t,n){return[t,[e["won"+n],e["tied"+n],e["lost"+n]]]}).toObject()}},cases:function(e){return this.__getSQL__("SELECT * FROM "+this.__tableName__).map(this.__row2case__.bind(this))},__nn_sql__:function(e,t){var n=this.encoding(t);return"SELECT *, ("+u.zip(this.__featureColumns__,n.features).mapApply(function(e,t){return null===t||isNaN(t)?"0":"abs(ifnull("+e+"-("+t+"),0))"}).join("+")+") AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+e},nn:function(e,t){var n=this,r=this.__nn_sql__(e,t);return this.__db__.prepare(r).all().map(function(e){return[n.__row2case__(e),e.distance]})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(e){return h.__SERMAT__.serialize_CaseBase(e)}}}),l.utils.encodings={TicTacToe:function(e,t,n){return{ply:n,features:e.board.split("").map(function(e){return"X"===e?1:"O"===e?-1:0}),actions:t?e.players.map(function(e){return t.hasOwnProperty(e)?t[e]:null}):null}}},l});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map