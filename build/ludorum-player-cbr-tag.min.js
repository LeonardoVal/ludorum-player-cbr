//! ludorum-player-cbr 0.0.1

(function(a){"use strict";this["ludorum-player-cbr"]=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";var e=b.declare,f=(b.raise,b.raiseIf),g=b.Randomness,h=b.Iterable,i=b.iterable,j=b.Future,k={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b,d]}};k.CBRDatabase=e({constructor:function(a){var b=this;this.cases=a&&a.cases||[],this.index=a&&a.index||i(this.cases).map(function(a,c){return[b.___caseKey__(a),c]}).toObject(),this.featureFunction=a&&a.featureFunction,this.maxDistance=a&&a.maxDistance||1/0,this.totalCount=i(this.cases).map(function(a){return 0|a.count}).sum()},___caseKey__:function(a){return a.join(" ")},features:function(a,b){return this.featureFunction(a,b)},addCase:function(a,b){var c=this.___caseKey__(a),d=this.index[c];"undefined"==typeof d?(a=a.slice(),this.index[c]=this.cases.length,this.cases.push(a),a.result=i(b).mapApply(function(a,b){return[a,[0,0,0]]}).toObject()):a=this.cases[d],a.count=(a.count||0)+1;for(var e in b)b[e]>0?a.result[e][0]++:b[e]<0?a.result[e][2]++:a.result[e][1]++;return this.totalCount++,a.count},addMatch:function(a){var b=this,c=[];return a.events.on("move",function(a,d){var e=b.features(a,d);c.push(e)}),a.run().then(function(){var d=a.result(),e=0;return c.forEach(function(a){e+=b.addCase(a,d)}),e})},addMatches:function(a){var c=this;return b.Future.sequence(a,function(a){return c.addMatch(a)})},addRandomMatches:function(a,c){return this.addMatches(b.Iterable.range(a).map(function(){return d.players.RandomPlayer.playTo(c)}))},addMatchesBetween:function(a,b,c){var e=h.product.apply(h,h.repeat(c,b.players.length).toArray()).toArray();return a=Math.ceil(a/e.length),this.addMatches(h.range(a).product(e).mapApply(function(a,c){return new d.Match(b,c)}))},distance:function(a,c){return b.iterable(a).zip(c).mapApply(function(a,b){return Math.abs(a-b)}).sum()},knn:function(a,b){var c=this,d=this.features(b),e=this.cases.map(function(a){return[a,c.distance(d,a)]});return e.sort(function(a,b){return a[1]-b[1]}),e.slice(0,+a)},"static __SERMAT__":{identifier:"CBRDatabase",serializer:function(a){return[{cases:a.cases,featureFunction:a.featureFunction,maxDistance:a.maxDistance}]}}}),k.CBRPlayer=e(d.Player,{constructor:function(a){d.Player.call(this,a),this.caseDB=a&&a.caseDB,this.caseN=a&&a.caseN||100},evaluatedMoves:function(a,c){var d=this.caseDB,e=(this.caseDB.features(a),b.iterable(this.movesFor(a,c)).map(function(a){return[a+"",[a,0]]}).toObject());return b.iterable(d.knn(this.caseN,a,c)).mapApply(function(a,b){var f=a[a.length-1],g=e[f+""];g&&(g[1]+=(a.result[c][0]-a.result[c][2])/a.count/d.totalCount)}),Object.values(e)},decision:function(a,b){var c=this.evaluatedMoves(a,b),d=i(c).greater(function(a){return a[1]}).map(function(a){return a[0]});return f(!d||!d.length,"No moves where selected at ",a," for player ",b,"!"),1===d.length?d[0]:g.DEFAULT.choice(d)},assess:function(a,b,c){var e=this,f=i(a.players).map(function(a){return[a,[0,0,0]]}).toObject();return c=+c||100,j.sequence(h.range(c/2),function(c){var g=new d.Match(a,[b,e]);return g.run().then(function(){var b=g.result()[a.players[0]];f[a.players[0]][b>0?0:b<0?2:1]++}).then(function(){var c=new d.Match(a,[b,e]);return c.run().then(function(){var b=c.result()[a.players[1]];f[a.players[1]][b>0?0:b<0?2:1]++})})}).then(function(){return f})}});return k});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map