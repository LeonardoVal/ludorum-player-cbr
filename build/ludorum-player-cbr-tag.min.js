//! ludorum-player-cbr 0.0.1

(function(a){"use strict";this["ludorum-player-cbr"]=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";var e=b.declare,f=b.objects.unimplemented,g=(b.raise,b.raiseIf,b.Randomness),h=b.Iterable,i=b.iterable,j=b.Future,k={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b,d]},dbs:{},utils:{}},l=k.CaseBase=b.declare({constructor:function(a){this.game=a&&a.game,a&&"function"==typeof a.encoding&&(this.encoding=a.encoding),a&&"function"==typeof a.distance&&(this.distance=a.distance),this.random=a&&a.random||g.DEFAULT},encoding:f("CaseBase","encoding(game, moves, ply)"),distance:function(a,c){return b.Iterable.zip(a,c).mapApply(function(a,b){return null===a||isNaN(a)||null===b||isNaN(b)?0:Math.abs(a-b)}).sum()},addCase:f("CaseBase","addCase(_case)"),addMatch:function(a,b){var c=this;return a.run().then(function(){var b=a.result(),d=0;return c.game.players.forEach(function(a){b[a]=[b[a]>0?1:0,0===b[a]?1:0,b[a]<0?1:0]}),a.history.forEach(function(a){if(a.moves){var e=c.encoding(a.state,a.moves,d);d++,e.result=b,c.addCase(e)}}),a})},addMatches:function(a,b){var c=this;return j.sequence(a,function(a){return c.addMatch(a,b)})},populate:function(a){a=a||{};var b=a.game||this.game,c=a.n||100,e=a.players||[new d.players.RandomPlayer],f=h.product.apply(h,h.repeat(e,b.players.length).toArray()).toArray();return this.addMatches(h.range(Math.ceil(c/f.length)).product(f).mapApply(function(a,c){return new d.Match(b,c)}),a)},cases:f("CaseBase","cases(filters)"),nn:function(a,b){var c=this,d=this.encoding(b),e=this.cases().map(function(a){return[a,c.distance(a.features,d.features)]}).sorted(function(a,b){return a[1]-b[1]}).toArray();return e.slice(0,+a)},actionEvaluations:function(a,c,d){var e=this,f=d&&+d.k||10,g=a.players.indexOf(c),h=b.iterable(a.moves()[c]).map(function(a){return[a+"",[a,0]]}).toObject(),j=e.nn(f,a);return i(j).forEachApply(function(a,b){var d=h[a.actions[g]];d&&(d[1]+=(a.result[c][0]-a.result[c][2])/(1+b))}),Object.values(h)},gameEvaluation:function(a,c,d){var e=this,f=d&&+d.k||10,g=(b.iterable(a.moves()[c]).map(function(a){return[a+"",[a,0]]}).toObject(),e.nn(f,a,c));return i(g).map(function(a,b){return(a.result[c][0]-a.result[c][2])/(1+b)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(a){return[{game:a.game,encoding:a.hasOwnProperty("encoding")?a.encoding:null}]}}});k.CBRPlayer=b.declare(d.Player,{constructor:function(a){d.Player.call(this,a),this.caseBase=a&&a.caseBase,this.k=a&&a.k||20},decision:function(a,b){var c=this.caseBase.actionEvaluations(a,b,{k:this.k}),d=c.filter(function(a){return a[1]>0}),e=c.filter(function(a){return a[1]<0}).map(function(a){return[a[0],-a[1]]});return console.log(d,e),d.length<1?e.length<1?this.random.choice(this.movesFor(a,b)):1===e.length?e[0][0]:this.random.weightedChoice(this.random.normalizeWeights(e)):1===d.length?d[0][0]:this.random.weightedChoice(this.random.normalizeWeights(d))},assess:function(a,c,e){var f=this,g=b.iterable(a.players).map(function(a){return[a,[0,0,0]]}).toObject(),h=b.Iterable.repeat(c,a.players.length).toArray();return e=+e||100,b.Future.sequence(b.Iterable.range(e),function(b){var c=h.slice(),e=b%a.players.length,i=a.players[e];c[e]=f;var j=new d.Match(a,c);return j.run().then(function(){var a=j.result()[i];g[i][a>0?0:a<0?2:1]++})}).then(function(){return g})}});k.dbs.MemoryCaseBase=e(l,{constructor:function(a){l.call(this,a),this.__cases__=[]},cases:function(){return b.iterable(this.__cases__)},addCase:function(a){var b={features:c.clone(a.features||null),actions:c.clone(a.actions||null),result:c.clone(a.result||null)};return this.__cases__.push(b)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(a){return l.__SERMAT__.serialize_CaseBase(a)}}});return k.dbs.SQLiteCaseBase=b.declare(l,{constructor:function(a){l.call(this,a),this.__setupDatabase__(a)},__setupDatabase__:function(a){var c=this.game,d=this.Database||require("better-sqlite3");this.__db__=new d(a.dbpath||"./"+c.name.toLowerCase()+"-cbr.sqlite");var e=this.encoding(c,c.moves()),f=e.features.map(function(a,b){return"f"+b}),g=c.players.map(function(a,b){return"a"+b}),h=b.Iterable.range(c.players.length).product(["won","tied","lost"]).mapApply(function(a,b){return b+a}).toArray(),i=f.concat(g).concat(h),j="CREATE TABLE IF NOT EXISTS Cases (key TEXT PRIMARY KEY, count INTEGER, "+i.map(function(a){return a+" INTEGER"}).join(", ")+")";this.__db__.prepare(j).run(),this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__distanceFunction__:function(a){a=a||this.distance;var b=[],c=[];return function(){for(var d=arguments.length/2|0,e=0;e<d;e++)b.push(arguments[e]),c.push(arguments[d+e]);return a(b,c)}},__key__:function(a){var b=a.features,c=a.actions||this.game.players.map(function(){return null});return b.join(",")+":"+c.join(",")},addCase:function(a){var c=this.game.players,d="'"+this.__key__(a)+"'",e="INSERT OR IGNORE INTO Cases VALUES ("+[d,0].concat(a.features.map(JSON.stringify)).concat(a.actions.map(JSON.stringify)).concat(b.Iterable.repeat(0,3*c.length).toArray()).join(",")+")";this.__db__.prepare(e).run(),e="UPDATE Cases SET count = count + 1, "+c.map(function(b){var d=a.result[b],e=c.indexOf(b),f=[];return d[0]&&f.push("won"+e+" = won"+e+" + "+d[0]),d[1]&&f.push("tied"+e+" = tied"+e+" + "+d[1]),d[2]&&f.push("lost"+e+" = lost"+e+" + "+d[2]),f.join(", ")}).join(", ")+" WHERE key = "+d,this.__db__.prepare(e).run()},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(a){return l.__SERMAT__.serialize_CaseBase(a)}}}),k.utils.encodings={TicTacToe:function(a,b){return{features:a.board.split("").map(function(a){return"X"===a?0:"O"===a?1:.5}),actions:b?a.players.map(function(a){return b.hasOwnProperty(a)?b[a]:null}):null}}},k});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map