//! ludorum-player-cbr 0.0.1

(function(a){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],a):"object"==typeof exports&&module.exports?module.exports=a(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";var e=(b.declare,b.raise,b.raiseIf,b.Randomness,b.Iterable,b.iterable,b.Future,{__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b,d]}});b.declare({constructor:function(a){this.game=a.game,this.__encoding__=a.encoding,this.maxDistance=a.maxDistance||1/0,this.minCount=a.minCount||2,this.random=a.random||b.Randomness.DEFAULT,this.__setupDatabase__(this.game)},__setupDatabase__:function(a){this.__db__=new Database("./"+a.name.toLowerCase()+"-cbr.db");var c=this.encoding(a,a.moves()),d=c.features.map(function(a,b){return"f"+b}),e=a.players.map(function(a,b){return"a"+b}),f=b.Iterable.range(a.players.length).product(["won","tied","lost"]).mapApply(function(a,b){return b+a}).toArray(),g="CREATE TABLE IF NOT EXISTS Cases (count INTEGER, "+d.concat(e).concat(f).map(function(a){return a+" INTEGER"}).join(", ")+",\nUNIQUE ("+d.concat(e).join(", ")+"))";this.__db__.prepare(g).run(),this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.distance)},encoding:function(a,b){return this.__encoding__(a,b)},distance:function(){for(var a,b,c=0,d=arguments.length/2|0,e=0;e<d;e++)a=arguments[e],b=arguments[d+e],null===a||isNaN(a)||null===b||isNaN(b)||(c+=Math.abs(a-b));return c},addCase:function(a,c,d){var e,f=this.game.players,g=" WHERE "+a.map(function(a,b){return"f"+b+(null===a?" IS NULL":" ="+a)}).join(" AND ")+" AND "+c.map(function(a,b){return"a"+b+(null===a?" IS NULL":" ="+a)}).join(" AND ");e="SELECT 1 FROM Cases "+g,this.__db__.prepare(e).get()||(e="INSERT INTO Cases VALUES (0,"+a.map(JSON.stringify).join(",")+", "+c.map(JSON.stringify).join(", ")+", "+b.Iterable.repeat(0,3*f.length).join(",")+")",this.__db__.prepare(e).run()),e="UPDATE Cases SET count = count + 1, "+f.map(function(a){var b=d[a],c=(b>0?"won":b<0?"lost":"tied")+f.indexOf(a);return c+"="+c+"+1"}).join(", ")+" WHERE "+a.map(function(a,b){return"f"+b+(null===a?" IS NULL":" ="+a)}).join(" AND ")+" AND "+c.map(function(a,b){return"a"+b+(null===a?" IS NULL":" ="+a)}).join(" AND "),this.__db__.prepare(e).run()},addMatch:function(a,b){var c,d=this,e=[];if(+b>0)for(var f=this.random.randomInt(b+1);f>0;f--){for(c=a.state();c.isContingent;)a.__advanceContingents__(random),c=a.state();moves=c.moves(),moves&&(move={},c.activePlayers.forEach(function(a){move[a]=d.random.choice(moves[a])}),a.__advance__(c,move),e.push(d.encoding(c,move)))}return a.events.on("move",function(a,b){var c=d.encoding(a,b);e.push(c)}),a.run().then(function(){var b=a.result(),c=0;return e.forEach(function(a){c+=d.addCase(a.features,a.actions,b)}),a})},addMatches:function(a,c){var d=this,e=0;return b.Future.sequence(a,function(a){return++e%10===0&&console.log("Training reached "+e+" matches. "+new Date),d.addMatch(a,c)})},populate:function(a){a=a||{};var c=a.game||this.game,e=a.n||100,f=a.players||[new d.players.RandomPlayer],g=b.Iterable.product.apply(b.Iterable,b.Iterable.repeat(f,c.players.length).toArray()).toArray();return this.addMatches(b.Iterable.range(Math.ceil(e/g.length)).product(g).mapApply(function(a,b){return new d.Match(c,b)}),a.maxPly)},knn:function(a,c,d){var e=c.players.indexOf(d),f=this.encoding(c),g=this.__db__.prepare("SELECT *, distance("+f.features.map(function(a,b){return"f"+b}).join(", ")+", "+f.features.join(", ")+") AS d FROM Cases WHERE a"+e+" IS NOT NULL ORDER BY d LIMIT "+a).all();return g.map(function(a){return{count:a.count,features:f.features.map(function(b,c){return a["f"+c]}),actions:b.iterable(c.players).map(function(b,c){return[b,a["a"+c]]}).toObject(),result:b.iterable(c.players).map(function(b,c){return[b,[a["won"+c],a["tied"+c],a["lost"+c]]]}).toObject(),distance:a.d}})},"static __SERMAT__":{identifier:"CBRDatabase",serializer:function(a){return[{cases:a.cases,featureFunction:a.featureFunction,maxDistance:a.maxDistance}]}}}),b.declare(d.Player,{constructor:function(a){d.Player.call(this,a),this.caseDB=a&&a.caseDB,this.caseN=a&&a.caseN||20},evaluatedMoves:function(a,c){var d=this.caseDB,e=b.iterable(this.movesFor(a,c)).map(function(a){return[a+"",[a,0]]}).toObject();return b.iterable(d.knn(this.caseN,a,c)).forEach(function(a){var b=e[a.actions[c]];b&&(b[1]+=(a.result[c][0]-a.result[c][2])/a.count)}),Object.values(e)},decision:function(a,c){var d,e=this.evaluatedMoves(a,c),f=b.iterable(e).greater(function(a){return a[1]}).map(function(a){return d=a[1],a[0]});return b.raiseIf(!f||!f.length,"No moves where selected at ",a," for player ",c,"!"),1===f.length?f[0]:b.Randomness.DEFAULT.choice(f)},assess:function(a,c,e){var f=this,g=b.iterable(a.players).map(function(a){return[a,[0,0,0]]}).toObject(),h=b.Iterable.repeat(c,a.players.length).toArray();return e=+e||100,b.Future.sequence(b.Iterable.range(e),function(b){var c=h.slice(),e=b%a.players.length,i=a.players[e];c[e]=f;var j=new d.Match(a,c);return j.run().then(function(){var a=j.result()[i];g[i][a>0?0:a<0?2:1]++})}).then(function(){return g})}});return e});
//# sourceMappingURL=ludorum-player-cbr.min.js.map