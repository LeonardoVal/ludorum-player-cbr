//! ludorum-player-cbr 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(_,n,l){"use strict";var t=_.declare,r=_.objects.unimplemented,u=_.raise,a=(_.raiseIf,_.Randomness),i=_.Iterable,h=_.iterable,s=_.Future,o={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[_,n,l],__SERMAT__:{include:[_,l]},dbs:{},utils:{}},c=o.CaseBase=_.declare({constructor:function(e){this.game=e&&e.game,e&&"function"==typeof e.encoding&&(this.encoding=e.encoding),e&&"function"==typeof e.distance&&(this.distance=e.distance),this.random=e&&e.random||a.DEFAULT},encoding:r("CaseBase","encoding(game, moves, ply)"),distance:function(e,t){return _.Iterable.zip(e,t).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},addCase:r("CaseBase","addCase(_case)"),addMatch:function(i,e){var o=this,u=+e.retainThreshold||0;return i.run().then(function(){var e,t,n,r=i.result(),a=i.history;o.game.players.forEach(function(e){r[e]=[0<r[e]?1:0,0===r[e]?1:0,r[e]<0?1:0]});for(var s=a.length-1;0<=s&&(!(e=a[s]).moves||((t=o.encoding(e.state,e.moves,s)).result=r,n=0!==u&&u>o.closestDistance(e.state),o.addCase(t),!n));s--);return i})},addMatches:function(e,t){var n=this,r=0,a=0;return t.logger&&(a=setInterval(function(){t.logger.info("Added "+r+" matches.")},t.logTime||3e4)),s.sequence(e,function(e){return r++,n.addMatch(e,t)}).then(function(e){return t.logger&&t.logger.info("Added "+r+" matches."),clearInterval(a),e})},populate:function(e){var n=(e=e||{}).game||this.game,t=isNaN(e.n)?100:+e.n,r=e.trainer||new l.players.RandomPlayer({name:"RandomPlayer"}),a=e.players||[r];Array.isArray(a)||(a=[a]);var s=new l.tournaments.Measurement(n,r,a,1).__matches__().toArray();return this.addMatches(i.range(Math.ceil(t/s.length)).product(s).mapApply(function(e,t){return new l.Match(n,t.players)}),e)},cases:r("CaseBase","cases(filters)"),nn:function(e,t){var n=this,r=this.encoding(t);return h(this.cases()).map(function(e){return[e,n.distance(e.features,r.features)]}).sorted(function(e,t){return e[1]-t[1]}).toArray().slice(0,+e)},closestDistance:function(e){var t=this.nn(1,e);return 0===t.length?1/0:t[0][1]},actionEvaluations:function(e,s,t){var n=t&&+t.k||10,i=e.players.indexOf(s),o=_.iterable(e.moves()[s]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),r=this.nn(n,e);return h(r).forEachApply(function(e,t){var n,r=o[JSON.stringify(e.actions[i])],a=e.result[s];r&&(n=e.count/(10+e.count)*(a[0]+a[2]&&(a[0]-a[2])/(a[0]+a[2]))*(1/(1+t)),isNaN(n)&&u("Action evaluation is NaN for case: ",JSON.stringify(e)," (distance= ",t,")!"),r[1]+=n)}),Object.values(o)},gameEvaluation:function(e,n,t){var r=t&&+t.k||10,a=(_.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),this.nn(r,e,n));return h(a).map(function(e,t){return(e.result[n][0]-e.result[n][2])/(1+t)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(e){return[{game:e.game,encoding:e.hasOwnProperty("encoding")?e.encoding:null}]}}});o.CBRPlayer=_.declare(l.Player,{constructor:function(e){l.Player.call(this,e),this.caseBase=e&&e.caseBase,this.k=e&&e.k||20},checkMoves:function(n,r){var a=[[],[]];return this.movesFor(n,r).forEach(function(e){var t=n.perform(e,r).result();t?0<t[r]&&a[0].push(e):a[1].push(e)}),a},decision:function(e,t){var n=this.checkMoves(e,t);if(0<n[0].length)return this.random.choice(n[0]);if(n[1].length<2)return 1===n[1].length?n[1][0]:this.random.choice(this.movesFor(e,t));var r=h(n[1]).map(function(e){return[e+"",[e,0]]}).toObject();this.caseBase.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=r[e[0]+""];t&&(t[1]+=e[1])});var a=1/0,s=Object.values(r).filter(function(e){return a=Math.min(a,e[1]),0<e[1]}),i=Object.values(r).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-a]});return 1<s.length?this.random.weightedChoice(this.random.normalizeWeights(s)):1===s.length?s[0][0]:this.random.weightedChoice(this.random.normalizeWeights(i))},assess:function(e,t){Array.isArray(e)||(e=[e]);var i=this,o=this.caseBase.game,u=h(e).map(function(e){return[e.name,h(o.players).map(function(e){return[e,[0,0,0]]}).toObject()]}).toObject(),n=t&&+t.n||300,c=0,r=0;return t.logger&&(r=setInterval(function(){t.logger.info("Assessment finished "+c+" matches.")},t.logTime||3e4)),_.Future.sequence(_.Iterable.range(n).product(e),function(e){var t=e[1],n=_.Iterable.repeat(t,o.players.length).toArray(),r=e[0]%o.players.length,a=o.players[r];n[r]=i;var s=new l.Match(o,n);return s.run().then(function(){var e=s.result()[a];u[t.name][a][0<e?0:e<0?2:1]++,c++})}).then(function(){return clearInterval(r),t.logger&&t.logger.info("Assessment finished "+c+" matches."),u})}}),o.dbs.MemoryCaseBase=t(c,{constructor:function(e){c.call(this,e),this.__cases__=[],this.__index__={}},cases:function(){return _.iterable(this.__cases__)},addCase:function(e){var t={count:e.count||0,ply:e.ply,features:n.clone(e.features||null),actions:n.clone(e.actions||null),result:n.clone(e.result||null)};return this.__cases__.push(t)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return c.__SERMAT__.serialize_CaseBase(e)}}});return o.dbs.SQLiteCaseBase=_.declare(c,{constructor:function(e){c.call(this,e),this.__setupDatabase__(e)},__setupDatabase__:function(e){var t=this.game,n=this.Database||require("better-sqlite3");e.db instanceof n?this.__db__=e.db:(this.__db__=new n("string"==typeof e.db?e.db:"./"+t.name.toLowerCase()+"-cbr.sqlite"),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"')),this.__tableName__=e.tableName||"CB_"+t.name;var r=this.encoding(t,t.moves());this.__featureColumns__=r.features.map(function(e,t){return"f"+t}),this.__actionColumns__=t.players.map(function(e,t){return"a"+t}),this.__resultColumns__=_.Iterable.range(t.players.length).product(["won","tied","lost"]).mapApply(function(e,t){return t+e}).toArray(),this.__createTable__(),this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__createTable__:function(e,t,n,r){return e=e||this.__tableName__,t=t||this.__featureColumns__,n=n||this.__actionColumns__,r=r||this.__resultColumns__,this.__runSQL__("CREATE TABLE IF NOT EXISTS "+e+"(key TEXT PRIMARY KEY, count INTEGER, ply REAL, "+n.map(function(e){return e+" TEXT"}).join(", ")+", "+r.concat(t).map(function(e){return e+" INTEGER"}).join(", ")+")")},__runSQL__:function(t){var n=Array.prototype.slice.call(arguments,1);try{var e=this.__db__.prepare(t);return e.run.apply(e,n)}catch(e){throw new Error("Error executing `"+t+"` "+JSON.stringify(n)+"!")}},__getSQL__:function(t){var n=Array.prototype.slice.call(arguments,1);try{var e=this.__db__.prepare(t);return e.all.apply(e,n)}catch(e){throw new Error("Error querying `"+t+"` "+JSON.stringify(n)+"!")}},__distanceFunction__:function(n){n=n||this.distance;var r=[],a=[];return function(){for(var e=arguments.length/2|0,t=0;t<e;t++)r.push(arguments[t]),a.push(arguments[e+t]);return n(r,a)}},__key__:function(e){var t=e.features,n=e.actions||this.game.players.map(function(){return null});return t.join(",")+":"+n.join(",")},addCase:function(a){var s=this.game.players,e=this.__key__(a),t="INSERT OR IGNORE INTO "+this.__tableName__+" VALUES ("+i.repeat("?",3+this.__actionColumns__.length+this.__resultColumns__.length+this.__featureColumns__.length).join(",")+")";0<this.__runSQL__(t,[e,1,a.ply].concat(a.actions.map(function(e){return null===e?null:JSON.stringify(e)})).concat(i.chain.apply(i,s.map(function(e){return a.result[e]})).toArray()).concat(a.features)).changes||this.__runSQL__("UPDATE "+this.__tableName__+" SET count = count + 1, ply = (ply * count + "+(a.ply||0)+") / (count + 1), "+s.map(function(e){var t=a.result[e],n=s.indexOf(e),r=[];return t[0]&&r.push("won"+n+" = won"+n+" + "+t[0]),t[1]&&r.push("tied"+n+" = tied"+n+" + "+t[1]),t[2]&&r.push("lost"+n+" = lost"+n+" + "+t[2]),r.join(", ")}).join(", ")+" WHERE key = '"+e+"'")},__row2case__:function(n){return{count:n.count,ply:n.ply,features:this.__featureColumns__.map(function(e){return n[e]}),actions:this.__actionColumns__.map(function(e){return JSON.parse(n[e])}),result:h(this.game.players).map(function(e,t){return[e,[n["won"+t],n["tied"+t],n["lost"+t]]]}).toObject()}},cases:function(e){return this.__getSQL__("SELECT * FROM "+this.__tableName__).map(this.__row2case__.bind(this))},__nn_sql__:function(e,t){var n=this.encoding(t);return"SELECT *, ("+i.zip(this.__featureColumns__,n.features).mapApply(function(e,t){return null===t||isNaN(t)?"0":"abs(ifnull("+e+"-("+t+"),0))"}).join("+")+") AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+e},nn:function(e,t){var n=this,r=this.__nn_sql__(e,t);return this.__db__.prepare(r).all().map(function(e){return[n.__row2case__(e),e.distance]})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(e){return c.__SERMAT__.serialize_CaseBase(e)}}}),o.utils.encodings={TicTacToe:function(e,t,n){return{ply:n,features:e.board.split("").map(function(e){return"X"===e?1:"O"===e?-1:0}),actions:t?e.players.map(function(e){return t.hasOwnProperty(e)?t[e]:null}):null}}},o});
//# sourceMappingURL=ludorum-player-cbr.min.js.map