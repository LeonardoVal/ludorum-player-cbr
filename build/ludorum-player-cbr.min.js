//! ludorum-player-cbr 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(_,n,l){"use strict";var t=_.declare,r=_.objects.unimplemented,a=(_.raise,_.raiseIf,_.Randomness),i=_.Iterable,h=_.iterable,s=_.Future,u={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[_,n,l],__SERMAT__:{include:[_,l]},dbs:{},utils:{}},o=u.CaseBase=_.declare({constructor:function(e){this.game=e&&e.game,e&&"function"==typeof e.encoding&&(this.encoding=e.encoding),e&&"function"==typeof e.distance&&(this.distance=e.distance),this.random=e&&e.random||a.DEFAULT},encoding:r("CaseBase","encoding(game, moves, ply)"),distance:function(e,t){return _.Iterable.zip(e,t).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},addCase:r("CaseBase","addCase(_case)"),addMatch:function(e,t){var a=this;return e.run().then(function(){var r=e.result();return a.game.players.forEach(function(e){r[e]=[0<r[e]?1:0,0===r[e]?1:0,r[e]<0?1:0]}),e.history.forEach(function(e,t){if(e.moves){var n=a.encoding(e.state,e.moves,t);n.result=r,a.addCase(n)}}),e})},addMatches:function(e,t){var n=this,r=0,a=0;return t.logger&&(a=setInterval(function(){t.logger.info("Added "+r+" matches.")},t.logTime||3e4)),s.sequence(e,function(e){return r++,n.addMatch(e,t)}).then(function(e){return t.logger&&t.logger.info("Added "+r+" matches."),clearInterval(a),e})},populate:function(e){var n=(e=e||{}).game||this.game,t=isNaN(e.n)?100:+e.n,r=e.trainer||new l.players.RandomPlayer({name:"RandomPlayer"}),a=e.players||[r];Array.isArray(a)||(a=[a]);var s=new l.tournaments.Measurement(n,r,a,1).__matches__().toArray();return this.addMatches(i.range(Math.ceil(t/s.length)).product(s).mapApply(function(e,t){return new l.Match(n,t.players)}),e)},cases:r("CaseBase","cases(filters)"),nn:function(e,t){var n=this,r=this.encoding(t);return h(this.cases()).map(function(e){return[e,n.distance(e.features,r.features)]}).sorted(function(e,t){return e[1]-t[1]}).toArray().slice(0,+e)},actionEvaluations:function(e,a,t){var n=t&&+t.k||10,s=e.players.indexOf(a),i=_.iterable(e.moves()[a]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),r=this.nn(n,e);return h(r).forEachApply(function(e,t){var n,r=i[JSON.stringify(e.actions[s])];r&&(n=e.result[a][0]+e.result[a][1]+e.result[a][2],r[1]+=n*(e.result[a][0]-e.result[a][2])/(10+n)/(1+t))}),Object.values(i)},gameEvaluation:function(e,n,t){var r=t&&+t.k||10,a=(_.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),this.nn(r,e,n));return h(a).map(function(e,t){return(e.result[n][0]-e.result[n][2])/(1+t)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(e){return[{game:e.game,encoding:e.hasOwnProperty("encoding")?e.encoding:null}]}}});u.CBRPlayer=_.declare(l.Player,{constructor:function(e){l.Player.call(this,e),this.caseBase=e&&e.caseBase,this.k=e&&e.k||20},decision:function(e,t){var n=h(this.movesFor(e,t)).map(function(e){return[e+"",[e,0]]}).toObject();this.caseBase.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=n[e[0]+""];t&&(t[1]+=e[1])});var r=1/0,a=Object.values(n).filter(function(e){return r=Math.min(r,e[1]),0<e[1]}),s=Object.values(n).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-r]});return 1<a.length?this.random.weightedChoice(this.random.normalizeWeights(a)):1===a.length?a[0][0]:this.random.weightedChoice(this.random.normalizeWeights(s))},assess:function(e,t){Array.isArray(e)||(e=[e]);var i=this,u=this.caseBase.game,o=h(e).map(function(e){return[e.name,h(u.players).map(function(e){return[e,[0,0,0]]}).toObject()]}).toObject(),n=t&&+t.n||300,c=0,r=0;return t.logger&&(r=setInterval(function(){t.logger.info("Assessment finished "+c+" matches.")},t.logTime||3e4)),_.Future.sequence(_.Iterable.range(n).product(e),function(e){var t=e[1],n=_.Iterable.repeat(t,u.players.length).toArray(),r=e[0]%u.players.length,a=u.players[r];n[r]=i;var s=new l.Match(u,n);return s.run().then(function(){var e=s.result()[a];o[t.name][a][0<e?0:e<0?2:1]++,c++})}).then(function(){return clearInterval(r),t.logger&&t.logger.info("Assessment finished "+c+" matches."),o})}}),u.dbs.MemoryCaseBase=t(o,{constructor:function(e){o.call(this,e),this.__cases__=[]},cases:function(){return _.iterable(this.__cases__)},addCase:function(e){var t={features:n.clone(e.features||null),actions:n.clone(e.actions||null),result:n.clone(e.result||null)};return this.__cases__.push(t)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return o.__SERMAT__.serialize_CaseBase(e)}}});return u.dbs.SQLiteCaseBase=_.declare(o,{constructor:function(e){o.call(this,e),this.__setupDatabase__(e)},__setupDatabase__:function(e){var t=this.game,n=this.Database||require("better-sqlite3");this.__db__=new n(e.dbpath||"./"+t.name.toLowerCase()+"-cbr.sqlite"),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"'),this.__tableName__=e.tableName||"CB_"+t.name;var r=this.encoding(t,t.moves());this.__featureColumns__=r.features.map(function(e,t){return"f"+t}),this.__actionColumns__=t.players.map(function(e,t){return"a"+t}),this.__resultColumns__=_.Iterable.range(t.players.length).product(["won","tied","lost"]).mapApply(function(e,t){return t+e}).toArray();var a="CREATE TABLE IF NOT EXISTS "+this.__tableName__+"(key TEXT PRIMARY KEY, count INTEGER, ply REAL, "+this.__actionColumns__.map(function(e){return e+" TEXT"}).join(", ")+", "+this.__resultColumns__.concat(this.__featureColumns__).map(function(e){return e+" INTEGER"}).join(", ")+")";try{this.__db__.prepare(a).run()}catch(e){throw new Error("Error while creating table. SQL: `"+a+"`!")}this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__distanceFunction__:function(n){n=n||this.distance;var r=[],a=[];return function(){for(var e=arguments.length/2|0,t=0;t<e;t++)r.push(arguments[t]),a.push(arguments[e+t]);return n(r,a)}},__key__:function(e){var t=e.features,n=e.actions||this.game.players.map(function(){return null});return t.join(",")+":"+n.join(",")},addCase:function(a){var s=this.game.players,e=this.__key__(a),t="INSERT OR IGNORE INTO "+this.__tableName__+" VALUES ("+i.repeat("?",3+this.__actionColumns__.length+this.__resultColumns__.length+this.__featureColumns__.length).join(",")+")",n=this.__db__.prepare(t);0<n.run.apply(n,[e,1,a.ply].concat(a.actions.map(function(e){return null===e?null:JSON.stringify(e)})).concat(i.chain.apply(i,s.map(function(e){return a.result[e]})).toArray()).concat(a.features)).changes||(t="UPDATE "+this.__tableName__+" SET count = count + 1, ply = (ply * count + "+(a.ply||0)+") / (count + 1), "+s.map(function(e){var t=a.result[e],n=s.indexOf(e),r=[];return t[0]&&r.push("won"+n+" = won"+n+" + "+t[0]),t[1]&&r.push("tied"+n+" = tied"+n+" + "+t[1]),t[2]&&r.push("lost"+n+" = lost"+n+" + "+t[2]),r.join(", ")}).join(", ")+" WHERE key = '"+e+"'",this.__db__.prepare(t).run())},__row2case__:function(n){return{ply:n.ply,features:this.__featureColumns__.map(function(e){return n[e]}),actions:this.__actionColumns__.map(function(e){return JSON.parse(n[e])}),result:h(this.game.players).map(function(e,t){return[e,[n["won"+t],n["tied"+t],n["lost"+t]]]}).toObject()}},cases:function(e){var t="SELECT * FROM "+this.__tableName__;return this.__db__.prepare(t).all().map(this.__row2case__.bind(this))},__nn_sql__:function(e,t){var n=this.encoding(t);return"SELECT *, ("+i.zip(this.__featureColumns__,n.features).mapApply(function(e,t){return null===t||isNaN(t)?"0":"abs(ifnull("+e+"-("+t+"),0))"}).join("+")+") AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+e},nn:function(e,t){var n=this,r=this.__nn_sql__(e,t);return this.__db__.prepare(r).all().map(function(e){return[n.__row2case__(e),e.distance]})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(e){return o.__SERMAT__.serialize_CaseBase(e)}}}),u.utils.encodings={TicTacToe:function(e,t,n){return{ply:n,features:e.board.split("").map(function(e){return"X"===e?1:"O"===e?2:0}),actions:t?e.players.map(function(e){return t.hasOwnProperty(e)?t[e]:null}):null}}},u});
//# sourceMappingURL=ludorum-player-cbr.min.js.map