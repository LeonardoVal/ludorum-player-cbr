//! ludorum-player-cbr 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(_,n,l){"use strict";var t=_.declare,r=_.objects.unimplemented,a=(_.raise,_.raiseIf,_.Randomness),s=_.Iterable,u=_.iterable,i=_.Future,o={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[_,n,l],__SERMAT__:{include:[_,l]},dbs:{},utils:{}},c=o.CaseBase=_.declare({constructor:function(e){this.game=e&&e.game,e&&"function"==typeof e.encoding&&(this.encoding=e.encoding),e&&"function"==typeof e.distance&&(this.distance=e.distance),this.random=e&&e.random||a.DEFAULT},encoding:r("CaseBase","encoding(game, moves, ply)"),distance:function(e,t){return _.Iterable.zip(e,t).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},addCase:r("CaseBase","addCase(_case)"),addMatch:function(e,t){var a=this;return e.run().then(function(){var n=e.result(),r=0;return a.game.players.forEach(function(e){n[e]=[0<n[e]?1:0,0===n[e]?1:0,n[e]<0?1:0]}),e.history.forEach(function(e){if(e.moves){var t=a.encoding(e.state,e.moves,r);r++,t.result=n,a.addCase(t)}}),e})},addMatches:function(e,t){var n=this,r=0;return i.sequence(e,function(e){return r++,t.logger&&r%10==0&&t.logger.info("Training reached "+r+" matches."),n.addMatch(e,t)})},populate:function(e){var n=(e=e||{}).game||this.game,t=e.n||100,r=e.players||[new l.players.RandomPlayer],a=s.product.apply(s,s.repeat(r,n.players.length).toArray()).toArray();return this.addMatches(s.range(Math.ceil(t/a.length)).product(a).mapApply(function(e,t){return new l.Match(n,t)}),e)},cases:r("CaseBase","cases(filters)"),nn:function(e,t){var n=this,r=this.encoding(t);return u(this.cases()).map(function(e){return[e,n.distance(e.features,r.features)]}).sorted(function(e,t){return e[1]-t[1]}).toArray().slice(0,+e)},actionEvaluations:function(e,r,t){var n=t&&+t.k||10,a=e.players.indexOf(r),s=_.iterable(e.moves()[r]).map(function(e){return[e+"",[e,0]]}).toObject(),i=this.nn(n,e);return u(i).forEachApply(function(e,t){var n=s[e.actions[a]];n&&(n[1]+=(e.result[r][0]-e.result[r][2])/(1+t))}),Object.values(s)},gameEvaluation:function(e,n,t){var r=t&&+t.k||10,a=(_.iterable(e.moves()[n]).map(function(e){return[e+"",[e,0]]}).toObject(),this.nn(r,e,n));return u(a).map(function(e,t){return(e.result[n][0]-e.result[n][2])/(1+t)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(e){return[{game:e.game,encoding:e.hasOwnProperty("encoding")?e.encoding:null}]}}});o.CBRPlayer=_.declare(l.Player,{constructor:function(e){l.Player.call(this,e),this.caseBase=e&&e.caseBase,this.k=e&&e.k||20},decision:function(e,t){var n=u(this.movesFor(e,t)).map(function(e){return[e+"",[e,0]]}).toObject();this.caseBase.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=n[e[0]+""];t&&(t[1]+=e[1])});var r=1/0,a=Object.values(n).filter(function(e){return r=Math.min(r,e[1]),0<e[1]}),s=Object.values(n).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-r]});return 1<a.length?this.random.weightedChoice(this.random.normalizeWeights(a)):1===a.length?a[0][0]:this.random.weightedChoice(this.random.normalizeWeights(s))},assess:function(e,s){var i=this,u=this.caseBase.game,o=_.iterable(u.players).map(function(e){return[e,[0,0,0]]}).toObject(),c=_.Iterable.repeat(e,u.players.length).toArray(),t=s&&+s.n||150;return _.Future.sequence(_.Iterable.range(t),function(t){var e=c.slice(),n=t%u.players.length,r=u.players[n];e[n]=i;var a=new l.Match(u,e);return a.run().then(function(){s.logger&&t%10==0&&s.logger.info("Assessment ran "+t+" matches.");var e=a.result()[r];o[r][0<e?0:e<0?2:1]++})}).then(function(){return o})}});o.dbs.MemoryCaseBase=t(c,{constructor:function(e){c.call(this,e),this.__cases__=[]},cases:function(){return _.iterable(this.__cases__)},addCase:function(e){var t={features:n.clone(e.features||null),actions:n.clone(e.actions||null),result:n.clone(e.result||null)};return this.__cases__.push(t)},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return c.__SERMAT__.serialize_CaseBase(e)}}});return o.dbs.SQLiteCaseBase=_.declare(c,{constructor:function(e){c.call(this,e),this.__setupDatabase__(e)},__setupDatabase__:function(e){var t=this.game,n=this.Database||require("better-sqlite3");this.__db__=new n(e.dbpath||"./"+t.name.toLowerCase()+"-cbr.sqlite"),this.__tableName__=e.tableName||"CB_"+t.name;var r=this.encoding(t,t.moves());this.__featureColumns__=r.features.map(function(e,t){return"f"+t}),this.__actionColumns__=t.players.map(function(e,t){return"a"+t}),this.__resultColumns__=_.Iterable.range(t.players.length).product(["won","tied","lost"]).mapApply(function(e,t){return t+e}).toArray();var a=this.__featureColumns__.concat(this.__actionColumns__).concat(this.__resultColumns__),s="CREATE TABLE IF NOT EXISTS "+this.__tableName__+"(key TEXT PRIMARY KEY, count INTEGER, "+a.map(function(e){return e+" INTEGER"}).join(", ")+")";try{this.__db__.prepare(s).run()}catch(e){throw new Error("Error while creating table. SQL: `"+s+"`!")}this.__db__.register({name:"distance",deterministic:!0,varargs:!0},this.__distanceFunction__(this.distance))},__distanceFunction__:function(n){n=n||this.distance;var r=[],a=[];return function(){for(var e=arguments.length/2|0,t=0;t<e;t++)r.push(arguments[t]),a.push(arguments[e+t]);return n(r,a)}},__key__:function(e){var t=e.features,n=e.actions||this.game.players.map(function(){return null});return t.join(",")+":"+n.join(",")},addCase:function(a){var s=this.game.players,e="'"+this.__key__(a)+"'",t="INSERT OR IGNORE INTO "+this.__tableName__+" VALUES ("+[e,0].concat(a.features.map(JSON.stringify)).concat(a.actions.map(JSON.stringify)).concat(_.Iterable.repeat(0,3*s.length).toArray()).join(",")+")";this.__db__.prepare(t).run(),t="UPDATE "+this.__tableName__+" SET count = count + 1, "+s.map(function(e){var t=a.result[e],n=s.indexOf(e),r=[];return t[0]&&r.push("won"+n+" = won"+n+" + "+t[0]),t[1]&&r.push("tied"+n+" = tied"+n+" + "+t[1]),t[2]&&r.push("lost"+n+" = lost"+n+" + "+t[2]),r.join(", ")}).join(", ")+" WHERE key = "+e,this.__db__.prepare(t).run()},cases:function(e){var t=this,n="SELECT * FROM "+this.__tableName__;return this.__db__.prepare(n).all().map(function(n){return{features:t.__featureColumns__.map(function(e){return n[e]}),actions:t.__actionColumns__.map(function(e){return n[e]}),result:u(t.game.players).map(function(e,t){return[e,[n["won"+t],n["tied"+t],n["lost"+t]]]}).toObject()}})},"static __SERMAT__":{identifier:"SQLiteCaseBase",serializer:function(e){return c.__SERMAT__.serialize_CaseBase(e)}}}),o.utils.encodings={TicTacToe:function(e,t){return{features:e.board.split("").map(function(e){return"X"===e?0:"O"===e?1:.5}),actions:t?e.players.map(function(e){return t.hasOwnProperty(e)?t[e]:null}):null}}},o});
//# sourceMappingURL=ludorum-player-cbr.min.js.map