//! ludorum-player-cbr 0.0.1

(function(t){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],t):"object"==typeof exports&&module.exports?module.exports=t(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=t(this.base,this.Sermat,this.ludorum)}).call(this,function e(r,n,a){"use strict";var i=r.declare,o=r.objects.unimplemented,u=r.raise,c=(r.raiseIf,r.Randomness),l=r.Iterable,_=r.iterable,f=r.Future,h={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[r,n,a],__SERMAT__:{include:[r,a]},dbs:{},games:{}},m=h.dbs,p=h.games,d=h.Case=i({constructor:function(t){this.count=+t.count||1,this.ply=+t.ply,this.features=t.features,this.actions=t.actions,this.results=t.results},"static fromGame":r.objects.unimplemented("Case","fromGame(game, ply, moves)"),addResult:function(t){var e;for(var r in t)e=t[r],Array.isArray(e)&&3===e.length?(this.results[r][0]+=t[r][0],this.results[r][1]+=t[r][1],this.results[r][2]+=t[r][2]):"number"==typeof e?this.results[r][e>0?0:0===e?1:2]++:u("Invalid result (",e,")!");this.count=(this.count||0)+1},merge:function(t){this.ply=(this.ply*this.count+t.ply*t.count)/(this.count+t.count),this.count+=t.count,this.addResult(t.result)},getMove:function(t,e){return this.actions[e]},identifier:function(){return this.features.join(",")+JSON.stringify(this.actions)},record:function(t){var e;for(e in(t=t||{}).id=this.identifier(),t.ply=this.ply,t.count=this.count,this.features.forEach(function(e,r){t["f"+r]=e}),this.actions)t["a_"+e]=JSON.stringify(this.actions[e]);for(e in this.results)t["won_"+e]=this.results[e][0],t["tied_"+e]=this.results[e][1],t["lost_"+e]=this.results[e][2];return t},"static fromRecord":function(t){var e=[],r={},n={};for(var s in t)"f"===s[0]?e[+s.substr(1)]=t[s]:"a_"===s.substr(0,2)&&(r[s.substr(2)]=JSON.parse(t[s]));for(var a in n)n[a]=[t["won_"+a],t["tied_"+a],t["lost_"+a]];return new this({count:t.count,ply:t.ply,features:e,actions:r,results:n})},"static emptyResults":function(t){return _(t).map(function(t){return[t,[0,0,0]]}).toObject()},"static actionsFromMoves":function(t,e){return _(t).map(function(t){return[t,e&&e.hasOwnProperty(t)?e[t]:null]}).toObject()},"static __SERMAT__":{identifier:"Case",serializer:function(t){return[{count:t.count,ply:t.ply,features:t.features,actions:t.actions,results:t.results}]}}}),y=h.CaseBase=i({constructor:function(t){this.game=t&&t.game,t&&"function"==typeof t.Case&&(this.Case=t.Case),this.random=t&&t.random||c.DEFAULT},distance:function(t,e){return r.Iterable.zip(t,e).mapApply(function(t,e){return null===t||isNaN(t)||null===e||isNaN(e)?0:Math.abs(t-e)}).sum()},addCase:o("CaseBase","addCase(_case)"),addMatch:function(t,e){var r=this;e.retainThreshold;return t.run().then(function(){for(var e,n=t.result(),s=t.history,a=s.length-1;a>=0;a--)(e=s[a]).moves&&r.Case.fromGame(e.state,a,e.moves).forEach(function(t){t.addResult(n),r.addCase(t)});return t})},addMatches:function(t,e){var r=this,n=0,s=0;return e.logger&&(s=setInterval(function(){e.logger.info("Added "+n+" matches.")},e.logTime||3e4)),f.sequence(t,function(t){return n++,r.addMatch(t,e)}).then(function(t){return e.logger&&e.logger.info("Added "+n+" matches."),clearInterval(s),t})},populate:function(t){var e=(t=t||{}).game||this.game,r=isNaN(t.n)?100:+t.n,n=t.trainer||new a.players.RandomPlayer({name:"RandomPlayer"}),s=t.players||[n];Array.isArray(s)||(s=[s]);var i=new a.tournaments.Measurement(e,n,s,1).__matches__().toArray();return this.addMatches(l.range(Math.ceil(r/i.length)).product(i).mapApply(function(t,r){return new a.Match(e,r.players)}),t)},cases:o("CaseBase","cases(filters)"),nn:function(t,e){var r=this,n=_(this.Case.fromGame(e));return _(this.cases()).map(function(t){var e=n.map(function(e){return r.distance(t.features,e.features)}).min();return[t,e]}).sorted(function(t,e){return t[1]-e[1]}).toArray().slice(0,+t)},closestDistance:function(t){var e=this.nn(1,t);return 0===e.length?1/0:e[0][1]},actionEvaluations:function(t,e,n){var s=n&&+n.k||10,a=t.players.indexOf(e),i=r.iterable(t.moves()[e]).map(function(t){return[JSON.stringify(t),[t,0]]}).toObject(),o=this.nn(s,t);return _(o).forEachApply(function(t,r){var n,s=i[JSON.stringify(t.actions[a])],o=t.results[e];s&&(n=t.count/(10+t.count)*(o[0]+o[2]&&(o[0]-o[2])/(o[0]+o[2]))*(1/(1+r)),isNaN(n)&&u("Action evaluation is NaN for case: ",JSON.stringify(t)," (distance= ",r,")!"),s[1]+=n)}),Object.values(i)},gameEvaluation:function(t,e,n){var s=n&&+n.k||10,a=(r.iterable(t.moves()[e]).map(function(t){return[JSON.stringify(t),[t,0]]}).toObject(),this.nn(s,t,e));return _(a).map(function(t,r){return(t.results[e][0]-t.results[e][2])/(1+r)}).sum()},"static __SERMAT__":{identifier:"CaseBase",serializer:function(t){return[{game:t.game,encoding:t.hasOwnProperty("encoding")?t.encoding:null}]}}});h.CBRPlayer=r.declare(a.Player,{constructor:function(t){a.Player.call(this,t),this.caseBase=t&&t.caseBase,this.k=t&&t.k||20},checkMoves:function(t,e){var r=[[],[]];return this.movesFor(t,e).forEach(function(n){var s=t.perform(n,e).result();s?s[e]>0&&r[0].push(n):r[1].push(n)}),r},decision:function(t,e){var r=this.checkMoves(t,e);if(r[0].length>0)return this.random.choice(r[0]);if(r[1].length<2)return 1===r[1].length?r[1][0]:this.random.choice(this.movesFor(t,e));var n=_(r[1]).map(function(t){return[t+"",[t,0]]}).toObject();this.caseBase.actionEvaluations(t,e,{k:this.k}).forEach(function(t){var e=n[t[0]+""];e&&(e[1]+=t[1])});var s=1/0,a=Object.values(n).filter(function(t){return s=Math.min(s,t[1]),t[1]>0}),i=Object.values(n).filter(function(t){return t[1]<=0}).map(function(t){return[t[0],t[1]-s]});return a.length>1?this.random.weightedChoice(this.random.normalizeWeights(a)):1===a.length?a[0][0]:this.random.weightedChoice(this.random.normalizeWeights(i))},assess:function(t,e){Array.isArray(t)||(t=[t]);var n=this,s=this.caseBase.game,i=_(t).map(function(t){return[t.name,_(s.players).map(function(t){return[t,[0,0,0]]}).toObject()]}).toObject(),o=e&&+e.n||300,u=0,c=0;return e.logger&&(c=setInterval(function(){e.logger.info("Assessment finished "+u+" matches.")},e.logTime||3e4)),r.Future.sequence(r.Iterable.range(o).product(t),function(t){var e=t[1],o=r.Iterable.repeat(e,s.players.length).toArray(),c=t[0]%s.players.length,l=s.players[c];o[c]=n;var _=new a.Match(s,o);return _.run().then(function(){var t=_.result()[l];i[e.name][l][t>0?0:t<0?2:1]++,u++})}).then(function(){return clearInterval(c),e.logger&&e.logger.info("Assessment finished "+u+" matches."),i})}}),m.MemoryCaseBase=i(y,{constructor:function(t){y.call(this,t),this.__cases__=[],this.__index__={}},cases:function(){return r.iterable(this.__cases__)},addCase:function(t){var e=t.identifier();if(this.__index__[e]){this.__cases__[this.__index__[e]].merge(t)}else{var r=this.__cases__.push(t)-1;this.__index__[e]=r}}});return m.SQLiteCaseBase=i(y,{constructor:function(t){y.call(this,t),this.__setupDatabase__(t)},__setupDatabase__:function(t){var e=this.game,r=this.Database||require("better-sqlite3");t.db instanceof r?this.__db__=t.db:(this.__db__=new r("string"==typeof t.db?t.db:"./"+e.name.toLowerCase()+"-cbr.sqlite"),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"')),this.__tableName__=t.tableName||"CB_"+e.name,this.__createTable__()},__createTable__:function(t,e){t=t||this.__tableName__,e=e||this.game;var r=this.Case.fromGame(e)[0],n=e.players.map(function(t){return"a_"+t+" TEXT"}).join(", "),s=e.players.map(function(t){return"won_"+t+" INTEGER, tied_"+t+" INTEGER, lost_"+t+" INTEGER"}).join(", "),a=r.features.map(function(t,e){return"f"+e+" INTEGER"}).join(", ");return this.__runSQL__("CREATE TABLE IF NOT EXISTS "+t+"(id TEXT PRIMARY KEY, count INTEGER, ply REAL, "+n+", "+s+", "+a+")")},__runSQL__:function(t){var e=Array.prototype.slice.call(arguments,1);try{var r=this.__db__.prepare(t);return r.run.apply(r,e)}catch(r){throw new Error("Error executing `"+t+"` "+JSON.stringify(e)+"!")}},__getSQL__:function(t){var e=Array.prototype.slice.call(arguments,1);try{var r=this.__db__.prepare(t);return r.all.apply(r,e)}catch(r){throw new Error("Error querying `"+t+"` "+JSON.stringify(e)+"!")}},addCase:function(t){var e=this.game.players,r=t.record(),n=Object.keys(r),s="INSERT OR IGNORE INTO "+this.__tableName__+" ("+n.join(",")+") VALUES ("+l.repeat("?",n.length).join(",")+")";this.__runSQL__(s,n.map(function(t){return r[t]})).changes>0||this.__runSQL__("UPDATE "+this.__tableName__+" SET count = count + 1, ply = (ply * count + "+(t.ply||0)+") / (count + 1), "+e.map(function(e){var r=t.results[e],n=[];return r[0]&&n.push("won_"+e+" = won_"+e+" + "+r[0]),r[1]&&n.push("tied_"+e+" = tied_"+e+" + "+r[1]),r[2]&&n.push("lost_"+e+" = lost_"+e+" + "+r[2]),n.join(", ")}).join(", ")+" WHERE id = '"+r.id+"'")},cases:function(){return this.__getSQL__("SELECT * FROM "+this.__tableName__).map(this.Case.fromRecord.bind(this.Case))},__nn_sql__:function(t,e){return"SELECT *, min("+this.Case.fromGame(e).map(function(t){return t.features.map(function(t,e){return null===t||isNaN(t)?"0":"abs(ifnull(f"+e+"-("+t+"),0))"}).join("+")}).join(", ")+") AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+t},nn:function(t,e){var r=this,n=this.__nn_sql__(t,e);return this.__db__.prepare(n).all().map(function(t){return[r.Case.fromRecord(t),t.distance]})}}),p.TicTacToe=function(){function t(t){return("string"==typeof t?t:t.board).split("").map(function(t){return"X"===t?1:"O"===t?-1:0})}var e=[[0,1,2,3,4,5,6,7,8],[2,1,0,5,4,3,8,7,6],[6,7,8,3,4,5,0,1,2],[6,3,0,7,4,1,8,5,2],[2,5,8,1,4,7,0,3,6],[8,7,6,5,4,3,2,1,0],[8,5,2,7,4,1,6,3,0],[0,3,6,1,4,7,2,5,8]];function r(t){var r="string"==typeof t?t:t.board,n=e.map(function(t){return t.map(function(t){return r.charAt(t)}).join("")});return n.sort(),n}return{directFeatures:t,DirectCase:i(d,{"static fromGame":function(e,r,n){return[new this({ply:+r,features:t(e),actions:d.actionsFromMoves(e.players,n),results:d.emptyResults(e.players)})]}}),equivalent:r,EquivalenceCase:i(d,{"static fromGame":function(e,n,s){var a=e.board.split(""),i=e.activePlayer();s&&(a[s[i]]="!");var o=r(a.join("")).map(function(t){var e=t.indexOf("!");return t.replace("!","_")+e});return o.sort(),a=o[0],s&&(s[i]=+a.substr(9)),[new this({ply:+n,features:t(a.substr(0,9)),actions:d.actionsFromMoves(e.players,s),results:d.emptyResults(e.players)})]}})}}(),p.Risk={Turn:function(t,e){var r=t.players.indexOf(r),n=t.players.indexOf(e);return n>r?n-r:6-(r-n)},Risk:function(e,r,n){return{ply:n,features:e.boardMap.territories.map(t=>turn(e,s[t][0])).concat(s[t][1]).concat(stage),actions:r?e.players.map(function(t){return r.hasOwnProperty(t)?r[t]:null}):null}}},h});
//# sourceMappingURL=ludorum-player-cbr.min.js.map